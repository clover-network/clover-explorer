"use strict";

var _create = require("@polkadot/types/create");

var _ = require(".");

// Copyright 2017-2020 @polkadot/rpc-core authors & contributors
// SPDX-License-Identifier: Apache-2.0
describe('methodSend', () => {
  const registry = new _create.TypeRegistry();
  let rpc;
  let methods;
  let provider;
  beforeEach(() => {
    methods = {
      blah: {
        description: 'test',
        params: [{
          name: 'foo',
          type: 'Bytes'
        }],
        type: 'Bytes'
      },
      bleh: {
        description: 'test',
        params: [],
        type: 'Bytes'
      }
    };
    provider = {
      send: jest.fn((method, params) => {
        return Promise.resolve(params[0]);
      })
    };
    rpc = new _.RpcCore('987', registry, provider);
  });
  it('checks for mismatched parameters', done => {
    // private method
    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment,@typescript-eslint/no-unsafe-call,@typescript-eslint/no-unsafe-member-access
    const method = rpc._createMethodSend('test', 'bleh', methods.bleh); // eslint-disable-next-line @typescript-eslint/no-unsafe-call,@typescript-eslint/no-unsafe-member-access


    method(1).subscribe(() => undefined, error => {
      expect(error.message).toMatch(/parameters, 1 found instead/);
      done();
    });
  });
  it('calls the provider with the correct parameters', done => {
    // private method
    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment,@typescript-eslint/no-unsafe-call,@typescript-eslint/no-unsafe-member-access
    const method = rpc._createMethodSend('test', 'blah', methods.blah); // Args are length-prefixed, because it's a Bytes
    // eslint-disable-next-line @typescript-eslint/no-unsafe-call,@typescript-eslint/no-unsafe-member-access


    method(new Uint8Array([2 << 2, 0x12, 0x34])).subscribe(() => {
      // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access
      expect(provider.send).toHaveBeenCalledWith('test_blah', ['0x1234']);
      done();
    });
  });
});