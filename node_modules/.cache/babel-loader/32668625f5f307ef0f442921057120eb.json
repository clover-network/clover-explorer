{"ast":null,"code":"function _typeof(obj) {\n  \"@babel/helpers - typeof\";\n\n  if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") {\n    _typeof = function _typeof(obj) {\n      return typeof obj;\n    };\n  } else {\n    _typeof = function _typeof(obj) {\n      return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj;\n    };\n  }\n\n  return _typeof(obj);\n}\n/**\n * @fileOverview 从xml建立自定义Node，包含update\n * @author xuzhi.mxz@antfin.com\n */\n\n\nimport { __assign, __rest } from \"tslib\";\nimport get from '@antv/util/lib/get';\nimport { getTextSize } from '../util/graphic';\n/**\n * 一种更宽松的JSON 解析，如果遇到不符合规范的字段会直接转为字符串\n * @param text json 内容\n */\n\nfunction looseJSONParse(text) {\n  if (typeof text !== 'string') {\n    return text;\n  }\n\n  var safeParse = function safeParse(str) {\n    if (typeof str !== 'string') {\n      return str;\n    }\n\n    try {\n      return JSON.parse(str.trim());\n    } catch (e) {\n      return str.trim();\n    }\n  };\n\n  var firstAttempt = safeParse(text);\n\n  if (typeof firstAttempt !== 'string') {\n    return firstAttempt;\n  }\n\n  var tail = function tail(arr) {\n    return arr[arr.length - 1];\n  };\n\n  var str = text.trim();\n  var objectStack = [];\n  var syntaxStack = [];\n\n  var isLastPair = function isLastPair() {\n    var syntaxes = [];\n\n    for (var _i = 0; _i < arguments.length; _i++) {\n      syntaxes[_i] = arguments[_i];\n    }\n\n    return syntaxes.some(function (syntax) {\n      return tail(syntaxStack) === syntax;\n    });\n  };\n\n  var getValueStore = function getValueStore() {\n    return tail(objectStack);\n  };\n\n  var rst = null;\n  var i = 0;\n  var temp = '';\n\n  while (i < str.length) {\n    var nowChar = str[i];\n    var isInString = isLastPair('\"', \"'\");\n\n    if (!isInString && !nowChar.trim()) {\n      i += 1;\n      continue;\n    }\n\n    var isLastTranslate = str[i - 1] === '\\\\';\n    var isInObject = isLastPair('}');\n    var isInArray = isLastPair(']');\n    var isWaitingValue = isLastPair(',');\n    var tempArr = getValueStore();\n\n    if (isInString) {\n      if (tail(syntaxStack) === nowChar && !isLastTranslate) {\n        syntaxStack.pop();\n        var value = safeParse(temp);\n        tempArr.push(value);\n        rst = value;\n        temp = '';\n      } else {\n        temp += nowChar;\n      }\n    } else if (isInArray && nowChar === ',') {\n      if (temp) {\n        tempArr.push(safeParse(temp));\n        temp = '';\n      }\n    } else if (isInObject && nowChar === ':') {\n      syntaxStack.push(',');\n\n      if (temp) {\n        tempArr.push(temp);\n        temp = '';\n      }\n    } else if (isWaitingValue && nowChar === ',') {\n      if (temp) {\n        tempArr.push(safeParse(temp));\n        temp = '';\n      }\n\n      syntaxStack.pop();\n    } else if (nowChar === '}' && (isInObject || isWaitingValue)) {\n      if (temp) {\n        tempArr.push(safeParse(temp));\n        temp = '';\n      }\n\n      if (isWaitingValue) {\n        syntaxStack.pop();\n      }\n\n      var obj = {};\n\n      for (var c = 1; c < tempArr.length; c += 2) {\n        obj[tempArr[c - 1]] = tempArr[c];\n      }\n\n      objectStack.pop();\n\n      if (objectStack.length) {\n        tail(objectStack).push(obj);\n      }\n\n      syntaxStack.pop();\n      rst = obj;\n    } else if (nowChar === ']' && isInArray) {\n      if (temp) {\n        tempArr.push(safeParse(temp));\n        temp = '';\n      }\n\n      objectStack.pop();\n\n      if (objectStack.length) {\n        tail(objectStack).push(tempArr);\n      }\n\n      syntaxStack.pop();\n      rst = tempArr;\n    } else if (nowChar === '{') {\n      objectStack.push([]);\n      syntaxStack.push('}');\n    } else if (nowChar === '[') {\n      objectStack.push([]);\n      syntaxStack.push(']');\n    } else if (nowChar === '\"') {\n      syntaxStack.push('\"');\n    } else if (nowChar === \"'\") {\n      syntaxStack.push(\"'\");\n    } else {\n      temp += nowChar;\n    }\n\n    i += 1;\n  }\n\n  return rst || temp;\n}\n\nvar keyConvert = function keyConvert(str) {\n  return str.split('-').reduce(function (a, b) {\n    return a + b.charAt(0).toUpperCase() + b.slice(1);\n  });\n};\n/**\n * 简单的一个{{}}模板渲染，不包含任何复杂语法\n * @param xml\n */\n\n\nexport var xmlDataRenderer = function xmlDataRenderer(xml) {\n  return function (data) {\n    var len = xml.length;\n    var arr = [];\n    var i = 0;\n    var tmp = '';\n\n    while (i < len) {\n      if (xml[i] === '{' && xml[i + 1] === '{') {\n        arr.push(tmp);\n        tmp = '';\n        i += 2;\n      } else if (xml[i] === '}' && xml[i + 1] === '}') {\n        if (arr.length) {\n          var last = arr.pop();\n          tmp = get(data, tmp, last.endsWith('=') ? \"\\\"{\" + tmp + \"}\\\"\" : tmp);\n          arr.push(last + tmp);\n        }\n\n        i += 2;\n        tmp = '';\n      } else {\n        tmp += xml[i];\n        i += 1;\n      }\n    }\n\n    arr.push(tmp);\n    return arr.map(function (e, index) {\n      return arr[index - 1] && arr[index - 1].endsWith('=') ? \"\\\"{\" + e + \"}\\\"\" : e;\n    }).join('');\n  };\n};\n/**\n * 解析XML，并转化为相应的JSON结构\n * @param xml xml解析后的节点\n */\n\nexport function parseXML(xml, cfg) {\n  var attrs = {};\n  var keys = xml.getAttributeNames && xml.getAttributeNames() || [];\n  var children = xml.children && Array.from(xml.children).map(function (e) {\n    return parseXML(e, cfg);\n  });\n  var rst = {};\n  var tagName = xml.tagName ? xml.tagName.toLowerCase() : 'group';\n\n  if (tagName === 'text') {\n    attrs.text = xml.innerText;\n  }\n\n  rst.type = tagName;\n\n  if (tagName === 'img') {\n    rst.type = 'image';\n  }\n\n  Array.from(keys).forEach(function (k) {\n    var key = keyConvert(k);\n    var val = xml.getAttribute(k);\n\n    try {\n      if (key === 'style' || key === 'attrs') {\n        var style = looseJSONParse(val);\n        attrs = __assign(__assign({}, attrs), style);\n      } else {\n        rst[key] = looseJSONParse(val);\n      }\n    } catch (e) {\n      if (key === 'style') {\n        throw e;\n      }\n\n      rst[key] = val;\n    }\n  });\n  rst.attrs = attrs;\n\n  if (cfg && cfg.style && rst.name && _typeof(cfg.style[rst.name]) === 'object') {\n    rst.attrs = __assign(__assign({}, rst.attrs), cfg.style[rst.name]);\n  }\n\n  if (cfg && cfg.style && rst.keyshape) {\n    rst.attrs = __assign(__assign({}, rst.attrs), cfg.style);\n  }\n\n  if (children.length) {\n    rst.children = children;\n  }\n\n  return rst;\n}\n/**\n * 根据偏移量和内部节点最终的bounding box来得出该shape最终的bbox\n */\n\nexport function getBBox(node, offset, chilrenBBox) {\n  var _a = node.attrs,\n      attrs = _a === void 0 ? {} : _a;\n  var bbox = {\n    x: offset.x || 0,\n    y: offset.y || 0,\n    width: chilrenBBox.width || 0,\n    height: chilrenBBox.height || 0\n  };\n  var shapeHeight, shapeWidth;\n\n  switch (node.type) {\n    case 'maker':\n    case 'circle':\n      if (attrs.r) {\n        shapeWidth = 2 * attrs.r;\n        shapeHeight = 2 * attrs.r;\n      }\n\n      break;\n\n    case 'text':\n      if (attrs.text) {\n        shapeWidth = getTextSize(attrs.text, attrs.fontSize || 12)[0];\n        shapeHeight = 16;\n        bbox.y += shapeHeight;\n        bbox.height = shapeHeight;\n        bbox.width = shapeWidth;\n        node.attrs = __assign({\n          fontSize: 12,\n          fill: '#000'\n        }, attrs);\n      }\n\n      break;\n\n    default:\n      if (attrs.width) {\n        shapeWidth = attrs.width;\n      }\n\n      if (attrs.height) {\n        shapeHeight = attrs.height;\n      }\n\n  }\n\n  if (shapeHeight >= 0) {\n    bbox.height = shapeHeight;\n  }\n\n  if (shapeWidth >= 0) {\n    bbox.width = shapeWidth;\n  }\n\n  if (attrs.marginTop) {\n    bbox.y += attrs.marginTop;\n  }\n\n  if (attrs.marginLeft) {\n    bbox.x += attrs.marginLeft;\n  }\n\n  return bbox;\n}\n/**\n * 把从xml计算出的结构填上位置信息，补全attrs\n * @param target\n * @param lastOffset\n */\n\nexport function generateTarget(target, lastOffset) {\n  var _a;\n\n  if (lastOffset === void 0) {\n    lastOffset = {\n      x: 0,\n      y: 0\n    };\n  }\n\n  var defaultBbox = __assign({\n    x: 0,\n    y: 0,\n    width: 0,\n    height: 0\n  }, lastOffset);\n\n  if ((_a = target.children) === null || _a === void 0 ? void 0 : _a.length) {\n    var _b = target.attrs,\n        attrs = _b === void 0 ? {} : _b;\n    var marginTop = attrs.marginTop;\n\n    var offset = __assign({}, lastOffset);\n\n    if (marginTop) {\n      offset.y += marginTop;\n    }\n\n    for (var index = 0; index < target.children.length; index++) {\n      target.children[index].attrs.key = (attrs.key || 'root') + \" -\" + index + \" \";\n      var node = generateTarget(target.children[index], offset);\n\n      if (node.bbox) {\n        var bbox = node.bbox;\n\n        if (node.attrs.next === 'inline') {\n          offset.x += node.bbox.width;\n        } else {\n          offset.y += node.bbox.height;\n        }\n\n        if (bbox.width + bbox.x > defaultBbox.width) {\n          defaultBbox.width = bbox.width + bbox.x;\n        }\n\n        if (bbox.height + bbox.y > defaultBbox.height) {\n          defaultBbox.height = bbox.height + bbox.y;\n        }\n      }\n    }\n  }\n\n  target.bbox = getBBox(target, lastOffset, defaultBbox);\n  target.attrs = __assign(__assign({}, target.attrs), target.bbox);\n  return target;\n}\n/**\n * 对比前后两个最终计算出来的node，并对比出最小改动,\n * 动作： 'add' 添加节点 ｜ ’delete‘ 删除节点 ｜ ’change‘ 改变节点attrs ｜ 'restructure' 重构节点\n * @param nowTarget\n * @param formerTarget\n */\n\nexport function compareTwoTarget(nowTarget, formerTarget) {\n  var _a, _b, _c, _d;\n\n  var type = (nowTarget || {}).type;\n  var key = ((formerTarget === null || formerTarget === void 0 ? void 0 : formerTarget.attrs) || {}).key;\n\n  if (key && nowTarget) {\n    nowTarget.attrs.key = key;\n  }\n\n  if (!nowTarget && formerTarget) {\n    return {\n      action: 'delete',\n      val: formerTarget,\n      type: type,\n      key: key\n    };\n  }\n\n  if (nowTarget && !formerTarget) {\n    return {\n      action: 'add',\n      val: nowTarget,\n      type: type\n    };\n  }\n\n  if (!nowTarget && !formerTarget) {\n    return {\n      action: 'same',\n      type: type\n    };\n  }\n\n  var children = [];\n\n  if (((_a = nowTarget.children) === null || _a === void 0 ? void 0 : _a.length) > 0 || ((_b = formerTarget.children) === null || _b === void 0 ? void 0 : _b.length) > 0) {\n    var length_1 = Math.max((_c = nowTarget.children) === null || _c === void 0 ? void 0 : _c.length, (_d = formerTarget.children) === null || _d === void 0 ? void 0 : _d.length);\n    var formerChilren = formerTarget.children || [];\n    var nowChilren = nowTarget.children || [];\n\n    for (var index = 0; index < length_1; index += 1) {\n      children.push(compareTwoTarget(nowChilren[index], formerChilren[index]));\n    }\n  }\n\n  var formerKeys = Object.keys(formerTarget.attrs);\n  var nowKeys = Object.keys(nowTarget.attrs);\n\n  if (formerTarget.type !== nowTarget.type) {\n    return {\n      action: 'restructure',\n      nowTarget: nowTarget,\n      formerTarget: formerTarget,\n      key: key,\n      children: children\n    };\n  }\n\n  if (formerKeys.filter(function (e) {\n    return e !== 'children';\n  }).some(function (e) {\n    return nowTarget.attrs[e] !== formerTarget.attrs[e] || !nowKeys.includes(e);\n  })) {\n    return {\n      action: 'change',\n      val: nowTarget,\n      children: children,\n      type: type,\n      key: key\n    };\n  }\n\n  return {\n    action: 'same',\n    children: children,\n    type: type,\n    key: key\n  };\n}\n/**\n * 根据xml或者返回xml的函数构建自定义节点的结构\n * @param gen\n */\n\nexport function createNodeFromXML(gen) {\n  var structures = {};\n\n  var compileXML = function compileXML(cfg) {\n    var rawStr = typeof gen === 'function' ? gen(cfg) : gen;\n    var target = xmlDataRenderer(rawStr)(cfg);\n    var xmlParser = document.createElement('div');\n    xmlParser.innerHTML = target;\n    var xml = xmlParser.children[0];\n    var result = generateTarget(parseXML(xml, cfg));\n    xmlParser.remove();\n    return result;\n  };\n\n  return {\n    draw: function draw(cfg, group) {\n      var resultTarget = compileXML(cfg);\n      var keyshape = group;\n\n      var renderTarget = function renderTarget(target) {\n        var _a = target.attrs,\n            attrs = _a === void 0 ? {} : _a,\n            bbox = target.bbox,\n            type = target.type,\n            children = target.children,\n            rest = __rest(target, [\"attrs\", \"bbox\", \"type\", \"children\"]);\n\n        if (target.type !== 'group') {\n          var shape = group.addShape(target.type, __assign({\n            attrs: attrs,\n            origin: {\n              bbox: bbox,\n              type: type,\n              children: children\n            }\n          }, rest));\n\n          if (target.keyshape) {\n            keyshape = shape;\n          }\n        }\n\n        if (target.children) {\n          target.children.forEach(function (n) {\n            return renderTarget(n);\n          });\n        }\n      };\n\n      renderTarget(resultTarget);\n      structures[cfg.id] = [resultTarget];\n      return keyshape;\n    },\n    update: function update(cfg, node) {\n      if (!structures[cfg.id]) {\n        structures[cfg.id] = [];\n      }\n\n      var container = node.getContainer();\n      var children = container.get('children');\n      var newTarget = compileXML(cfg);\n      var lastTarget = structures[cfg.id].pop();\n      var diffResult = compareTwoTarget(newTarget, lastTarget);\n\n      var addShape = function addShape(shape) {\n        var _a;\n\n        if (shape.type !== 'group') {\n          container.addShape(shape.type, {\n            attrs: shape.attrs\n          });\n        }\n\n        if ((_a = shape.children) === null || _a === void 0 ? void 0 : _a.length) {\n          shape.children.map(function (e) {\n            return addShape(e);\n          });\n        }\n      };\n\n      var delShape = function delShape(shape) {\n        var _a;\n\n        var targetShape = children.find(function (e) {\n          return e.attrs.key === shape.attrs.key;\n        });\n\n        if (targetShape) {\n          container.removeChild(targetShape);\n        }\n\n        if ((_a = shape.children) === null || _a === void 0 ? void 0 : _a.length) {\n          shape.children.map(function (e) {\n            return delShape(e);\n          });\n        }\n      };\n\n      var updateTarget = function updateTarget(target) {\n        var key = target.key;\n\n        if (target.type !== 'group') {\n          var targetShape = children.find(function (e) {\n            return e.attrs.key === key;\n          });\n\n          switch (target.action) {\n            case 'change':\n              if (targetShape) {\n                var originAttr = target.val.keyshape ? node.getOriginStyle() : {};\n                targetShape.attr(__assign(__assign({}, originAttr), target.val.attrs));\n              }\n\n              break;\n\n            case 'add':\n              addShape(target.val);\n              break;\n\n            case 'delete':\n              delShape(target.val);\n              break;\n\n            case 'restructure':\n              delShape(target.formerTarget);\n              addShape(target.nowTarget);\n              break;\n\n            default:\n              break;\n          }\n        }\n\n        if (target.children) {\n          target.children.forEach(function (n) {\n            return updateTarget(n);\n          });\n        }\n      };\n\n      updateTarget(diffResult);\n      structures[cfg.id].push(newTarget);\n    },\n    getAnchorPoints: function getAnchorPoints() {\n      return [[0, 0.5], [1, 0.5], [0.5, 1], [0.5, 0]];\n    }\n  };\n}","map":{"version":3,"sources":["/Users/wanglijie/wanglijie/clover-defi-wallet/node_modules/@antv/g6/es/shape/xml.js"],"names":["_typeof","obj","Symbol","iterator","constructor","prototype","__assign","__rest","get","getTextSize","looseJSONParse","text","safeParse","str","JSON","parse","trim","e","firstAttempt","tail","arr","length","objectStack","syntaxStack","isLastPair","syntaxes","_i","arguments","some","syntax","getValueStore","rst","i","temp","nowChar","isInString","isLastTranslate","isInObject","isInArray","isWaitingValue","tempArr","pop","value","push","c","keyConvert","split","reduce","a","b","charAt","toUpperCase","slice","xmlDataRenderer","xml","data","len","tmp","last","endsWith","map","index","join","parseXML","cfg","attrs","keys","getAttributeNames","children","Array","from","tagName","toLowerCase","innerText","type","forEach","k","key","val","getAttribute","style","name","keyshape","getBBox","node","offset","chilrenBBox","_a","bbox","x","y","width","height","shapeHeight","shapeWidth","r","fontSize","fill","marginTop","marginLeft","generateTarget","target","lastOffset","defaultBbox","_b","next","compareTwoTarget","nowTarget","formerTarget","_c","_d","action","length_1","Math","max","formerChilren","nowChilren","formerKeys","Object","nowKeys","filter","includes","createNodeFromXML","gen","structures","compileXML","rawStr","xmlParser","document","createElement","innerHTML","result","remove","draw","group","resultTarget","renderTarget","rest","shape","addShape","origin","n","id","update","container","getContainer","newTarget","lastTarget","diffResult","delShape","targetShape","find","removeChild","updateTarget","originAttr","getOriginStyle","attr","getAnchorPoints"],"mappings":"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","sourcesContent":["function _typeof(obj) { \"@babel/helpers - typeof\"; if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; }; } return _typeof(obj); }\n\n/**\n * @fileOverview 从xml建立自定义Node，包含update\n * @author xuzhi.mxz@antfin.com\n */\nimport { __assign, __rest } from \"tslib\";\nimport get from '@antv/util/lib/get';\nimport { getTextSize } from '../util/graphic';\n/**\n * 一种更宽松的JSON 解析，如果遇到不符合规范的字段会直接转为字符串\n * @param text json 内容\n */\n\nfunction looseJSONParse(text) {\n  if (typeof text !== 'string') {\n    return text;\n  }\n\n  var safeParse = function safeParse(str) {\n    if (typeof str !== 'string') {\n      return str;\n    }\n\n    try {\n      return JSON.parse(str.trim());\n    } catch (e) {\n      return str.trim();\n    }\n  };\n\n  var firstAttempt = safeParse(text);\n\n  if (typeof firstAttempt !== 'string') {\n    return firstAttempt;\n  }\n\n  var tail = function tail(arr) {\n    return arr[arr.length - 1];\n  };\n\n  var str = text.trim();\n  var objectStack = [];\n  var syntaxStack = [];\n\n  var isLastPair = function isLastPair() {\n    var syntaxes = [];\n\n    for (var _i = 0; _i < arguments.length; _i++) {\n      syntaxes[_i] = arguments[_i];\n    }\n\n    return syntaxes.some(function (syntax) {\n      return tail(syntaxStack) === syntax;\n    });\n  };\n\n  var getValueStore = function getValueStore() {\n    return tail(objectStack);\n  };\n\n  var rst = null;\n  var i = 0;\n  var temp = '';\n\n  while (i < str.length) {\n    var nowChar = str[i];\n    var isInString = isLastPair('\"', \"'\");\n\n    if (!isInString && !nowChar.trim()) {\n      i += 1;\n      continue;\n    }\n\n    var isLastTranslate = str[i - 1] === '\\\\';\n    var isInObject = isLastPair('}');\n    var isInArray = isLastPair(']');\n    var isWaitingValue = isLastPair(',');\n    var tempArr = getValueStore();\n\n    if (isInString) {\n      if (tail(syntaxStack) === nowChar && !isLastTranslate) {\n        syntaxStack.pop();\n        var value = safeParse(temp);\n        tempArr.push(value);\n        rst = value;\n        temp = '';\n      } else {\n        temp += nowChar;\n      }\n    } else if (isInArray && nowChar === ',') {\n      if (temp) {\n        tempArr.push(safeParse(temp));\n        temp = '';\n      }\n    } else if (isInObject && nowChar === ':') {\n      syntaxStack.push(',');\n\n      if (temp) {\n        tempArr.push(temp);\n        temp = '';\n      }\n    } else if (isWaitingValue && nowChar === ',') {\n      if (temp) {\n        tempArr.push(safeParse(temp));\n        temp = '';\n      }\n\n      syntaxStack.pop();\n    } else if (nowChar === '}' && (isInObject || isWaitingValue)) {\n      if (temp) {\n        tempArr.push(safeParse(temp));\n        temp = '';\n      }\n\n      if (isWaitingValue) {\n        syntaxStack.pop();\n      }\n\n      var obj = {};\n\n      for (var c = 1; c < tempArr.length; c += 2) {\n        obj[tempArr[c - 1]] = tempArr[c];\n      }\n\n      objectStack.pop();\n\n      if (objectStack.length) {\n        tail(objectStack).push(obj);\n      }\n\n      syntaxStack.pop();\n      rst = obj;\n    } else if (nowChar === ']' && isInArray) {\n      if (temp) {\n        tempArr.push(safeParse(temp));\n        temp = '';\n      }\n\n      objectStack.pop();\n\n      if (objectStack.length) {\n        tail(objectStack).push(tempArr);\n      }\n\n      syntaxStack.pop();\n      rst = tempArr;\n    } else if (nowChar === '{') {\n      objectStack.push([]);\n      syntaxStack.push('}');\n    } else if (nowChar === '[') {\n      objectStack.push([]);\n      syntaxStack.push(']');\n    } else if (nowChar === '\"') {\n      syntaxStack.push('\"');\n    } else if (nowChar === \"'\") {\n      syntaxStack.push(\"'\");\n    } else {\n      temp += nowChar;\n    }\n\n    i += 1;\n  }\n\n  return rst || temp;\n}\n\nvar keyConvert = function keyConvert(str) {\n  return str.split('-').reduce(function (a, b) {\n    return a + b.charAt(0).toUpperCase() + b.slice(1);\n  });\n};\n/**\n * 简单的一个{{}}模板渲染，不包含任何复杂语法\n * @param xml\n */\n\n\nexport var xmlDataRenderer = function xmlDataRenderer(xml) {\n  return function (data) {\n    var len = xml.length;\n    var arr = [];\n    var i = 0;\n    var tmp = '';\n\n    while (i < len) {\n      if (xml[i] === '{' && xml[i + 1] === '{') {\n        arr.push(tmp);\n        tmp = '';\n        i += 2;\n      } else if (xml[i] === '}' && xml[i + 1] === '}') {\n        if (arr.length) {\n          var last = arr.pop();\n          tmp = get(data, tmp, last.endsWith('=') ? \"\\\"{\" + tmp + \"}\\\"\" : tmp);\n          arr.push(last + tmp);\n        }\n\n        i += 2;\n        tmp = '';\n      } else {\n        tmp += xml[i];\n        i += 1;\n      }\n    }\n\n    arr.push(tmp);\n    return arr.map(function (e, index) {\n      return arr[index - 1] && arr[index - 1].endsWith('=') ? \"\\\"{\" + e + \"}\\\"\" : e;\n    }).join('');\n  };\n};\n/**\n * 解析XML，并转化为相应的JSON结构\n * @param xml xml解析后的节点\n */\n\nexport function parseXML(xml, cfg) {\n  var attrs = {};\n  var keys = xml.getAttributeNames && xml.getAttributeNames() || [];\n  var children = xml.children && Array.from(xml.children).map(function (e) {\n    return parseXML(e, cfg);\n  });\n  var rst = {};\n  var tagName = xml.tagName ? xml.tagName.toLowerCase() : 'group';\n\n  if (tagName === 'text') {\n    attrs.text = xml.innerText;\n  }\n\n  rst.type = tagName;\n\n  if (tagName === 'img') {\n    rst.type = 'image';\n  }\n\n  Array.from(keys).forEach(function (k) {\n    var key = keyConvert(k);\n    var val = xml.getAttribute(k);\n\n    try {\n      if (key === 'style' || key === 'attrs') {\n        var style = looseJSONParse(val);\n        attrs = __assign(__assign({}, attrs), style);\n      } else {\n        rst[key] = looseJSONParse(val);\n      }\n    } catch (e) {\n      if (key === 'style') {\n        throw e;\n      }\n\n      rst[key] = val;\n    }\n  });\n  rst.attrs = attrs;\n\n  if (cfg && cfg.style && rst.name && _typeof(cfg.style[rst.name]) === 'object') {\n    rst.attrs = __assign(__assign({}, rst.attrs), cfg.style[rst.name]);\n  }\n\n  if (cfg && cfg.style && rst.keyshape) {\n    rst.attrs = __assign(__assign({}, rst.attrs), cfg.style);\n  }\n\n  if (children.length) {\n    rst.children = children;\n  }\n\n  return rst;\n}\n/**\n * 根据偏移量和内部节点最终的bounding box来得出该shape最终的bbox\n */\n\nexport function getBBox(node, offset, chilrenBBox) {\n  var _a = node.attrs,\n      attrs = _a === void 0 ? {} : _a;\n  var bbox = {\n    x: offset.x || 0,\n    y: offset.y || 0,\n    width: chilrenBBox.width || 0,\n    height: chilrenBBox.height || 0\n  };\n  var shapeHeight, shapeWidth;\n\n  switch (node.type) {\n    case 'maker':\n    case 'circle':\n      if (attrs.r) {\n        shapeWidth = 2 * attrs.r;\n        shapeHeight = 2 * attrs.r;\n      }\n\n      break;\n\n    case 'text':\n      if (attrs.text) {\n        shapeWidth = getTextSize(attrs.text, attrs.fontSize || 12)[0];\n        shapeHeight = 16;\n        bbox.y += shapeHeight;\n        bbox.height = shapeHeight;\n        bbox.width = shapeWidth;\n        node.attrs = __assign({\n          fontSize: 12,\n          fill: '#000'\n        }, attrs);\n      }\n\n      break;\n\n    default:\n      if (attrs.width) {\n        shapeWidth = attrs.width;\n      }\n\n      if (attrs.height) {\n        shapeHeight = attrs.height;\n      }\n\n  }\n\n  if (shapeHeight >= 0) {\n    bbox.height = shapeHeight;\n  }\n\n  if (shapeWidth >= 0) {\n    bbox.width = shapeWidth;\n  }\n\n  if (attrs.marginTop) {\n    bbox.y += attrs.marginTop;\n  }\n\n  if (attrs.marginLeft) {\n    bbox.x += attrs.marginLeft;\n  }\n\n  return bbox;\n}\n/**\n * 把从xml计算出的结构填上位置信息，补全attrs\n * @param target\n * @param lastOffset\n */\n\nexport function generateTarget(target, lastOffset) {\n  var _a;\n\n  if (lastOffset === void 0) {\n    lastOffset = {\n      x: 0,\n      y: 0\n    };\n  }\n\n  var defaultBbox = __assign({\n    x: 0,\n    y: 0,\n    width: 0,\n    height: 0\n  }, lastOffset);\n\n  if ((_a = target.children) === null || _a === void 0 ? void 0 : _a.length) {\n    var _b = target.attrs,\n        attrs = _b === void 0 ? {} : _b;\n    var marginTop = attrs.marginTop;\n\n    var offset = __assign({}, lastOffset);\n\n    if (marginTop) {\n      offset.y += marginTop;\n    }\n\n    for (var index = 0; index < target.children.length; index++) {\n      target.children[index].attrs.key = (attrs.key || 'root') + \" -\" + index + \" \";\n      var node = generateTarget(target.children[index], offset);\n\n      if (node.bbox) {\n        var bbox = node.bbox;\n\n        if (node.attrs.next === 'inline') {\n          offset.x += node.bbox.width;\n        } else {\n          offset.y += node.bbox.height;\n        }\n\n        if (bbox.width + bbox.x > defaultBbox.width) {\n          defaultBbox.width = bbox.width + bbox.x;\n        }\n\n        if (bbox.height + bbox.y > defaultBbox.height) {\n          defaultBbox.height = bbox.height + bbox.y;\n        }\n      }\n    }\n  }\n\n  target.bbox = getBBox(target, lastOffset, defaultBbox);\n  target.attrs = __assign(__assign({}, target.attrs), target.bbox);\n  return target;\n}\n/**\n * 对比前后两个最终计算出来的node，并对比出最小改动,\n * 动作： 'add' 添加节点 ｜ ’delete‘ 删除节点 ｜ ’change‘ 改变节点attrs ｜ 'restructure' 重构节点\n * @param nowTarget\n * @param formerTarget\n */\n\nexport function compareTwoTarget(nowTarget, formerTarget) {\n  var _a, _b, _c, _d;\n\n  var type = (nowTarget || {}).type;\n  var key = ((formerTarget === null || formerTarget === void 0 ? void 0 : formerTarget.attrs) || {}).key;\n\n  if (key && nowTarget) {\n    nowTarget.attrs.key = key;\n  }\n\n  if (!nowTarget && formerTarget) {\n    return {\n      action: 'delete',\n      val: formerTarget,\n      type: type,\n      key: key\n    };\n  }\n\n  if (nowTarget && !formerTarget) {\n    return {\n      action: 'add',\n      val: nowTarget,\n      type: type\n    };\n  }\n\n  if (!nowTarget && !formerTarget) {\n    return {\n      action: 'same',\n      type: type\n    };\n  }\n\n  var children = [];\n\n  if (((_a = nowTarget.children) === null || _a === void 0 ? void 0 : _a.length) > 0 || ((_b = formerTarget.children) === null || _b === void 0 ? void 0 : _b.length) > 0) {\n    var length_1 = Math.max((_c = nowTarget.children) === null || _c === void 0 ? void 0 : _c.length, (_d = formerTarget.children) === null || _d === void 0 ? void 0 : _d.length);\n    var formerChilren = formerTarget.children || [];\n    var nowChilren = nowTarget.children || [];\n\n    for (var index = 0; index < length_1; index += 1) {\n      children.push(compareTwoTarget(nowChilren[index], formerChilren[index]));\n    }\n  }\n\n  var formerKeys = Object.keys(formerTarget.attrs);\n  var nowKeys = Object.keys(nowTarget.attrs);\n\n  if (formerTarget.type !== nowTarget.type) {\n    return {\n      action: 'restructure',\n      nowTarget: nowTarget,\n      formerTarget: formerTarget,\n      key: key,\n      children: children\n    };\n  }\n\n  if (formerKeys.filter(function (e) {\n    return e !== 'children';\n  }).some(function (e) {\n    return nowTarget.attrs[e] !== formerTarget.attrs[e] || !nowKeys.includes(e);\n  })) {\n    return {\n      action: 'change',\n      val: nowTarget,\n      children: children,\n      type: type,\n      key: key\n    };\n  }\n\n  return {\n    action: 'same',\n    children: children,\n    type: type,\n    key: key\n  };\n}\n/**\n * 根据xml或者返回xml的函数构建自定义节点的结构\n * @param gen\n */\n\nexport function createNodeFromXML(gen) {\n  var structures = {};\n\n  var compileXML = function compileXML(cfg) {\n    var rawStr = typeof gen === 'function' ? gen(cfg) : gen;\n    var target = xmlDataRenderer(rawStr)(cfg);\n    var xmlParser = document.createElement('div');\n    xmlParser.innerHTML = target;\n    var xml = xmlParser.children[0];\n    var result = generateTarget(parseXML(xml, cfg));\n    xmlParser.remove();\n    return result;\n  };\n\n  return {\n    draw: function draw(cfg, group) {\n      var resultTarget = compileXML(cfg);\n      var keyshape = group;\n\n      var renderTarget = function renderTarget(target) {\n        var _a = target.attrs,\n            attrs = _a === void 0 ? {} : _a,\n            bbox = target.bbox,\n            type = target.type,\n            children = target.children,\n            rest = __rest(target, [\"attrs\", \"bbox\", \"type\", \"children\"]);\n\n        if (target.type !== 'group') {\n          var shape = group.addShape(target.type, __assign({\n            attrs: attrs,\n            origin: {\n              bbox: bbox,\n              type: type,\n              children: children\n            }\n          }, rest));\n\n          if (target.keyshape) {\n            keyshape = shape;\n          }\n        }\n\n        if (target.children) {\n          target.children.forEach(function (n) {\n            return renderTarget(n);\n          });\n        }\n      };\n\n      renderTarget(resultTarget);\n      structures[cfg.id] = [resultTarget];\n      return keyshape;\n    },\n    update: function update(cfg, node) {\n      if (!structures[cfg.id]) {\n        structures[cfg.id] = [];\n      }\n\n      var container = node.getContainer();\n      var children = container.get('children');\n      var newTarget = compileXML(cfg);\n      var lastTarget = structures[cfg.id].pop();\n      var diffResult = compareTwoTarget(newTarget, lastTarget);\n\n      var addShape = function addShape(shape) {\n        var _a;\n\n        if (shape.type !== 'group') {\n          container.addShape(shape.type, {\n            attrs: shape.attrs\n          });\n        }\n\n        if ((_a = shape.children) === null || _a === void 0 ? void 0 : _a.length) {\n          shape.children.map(function (e) {\n            return addShape(e);\n          });\n        }\n      };\n\n      var delShape = function delShape(shape) {\n        var _a;\n\n        var targetShape = children.find(function (e) {\n          return e.attrs.key === shape.attrs.key;\n        });\n\n        if (targetShape) {\n          container.removeChild(targetShape);\n        }\n\n        if ((_a = shape.children) === null || _a === void 0 ? void 0 : _a.length) {\n          shape.children.map(function (e) {\n            return delShape(e);\n          });\n        }\n      };\n\n      var updateTarget = function updateTarget(target) {\n        var key = target.key;\n\n        if (target.type !== 'group') {\n          var targetShape = children.find(function (e) {\n            return e.attrs.key === key;\n          });\n\n          switch (target.action) {\n            case 'change':\n              if (targetShape) {\n                var originAttr = target.val.keyshape ? node.getOriginStyle() : {};\n                targetShape.attr(__assign(__assign({}, originAttr), target.val.attrs));\n              }\n\n              break;\n\n            case 'add':\n              addShape(target.val);\n              break;\n\n            case 'delete':\n              delShape(target.val);\n              break;\n\n            case 'restructure':\n              delShape(target.formerTarget);\n              addShape(target.nowTarget);\n              break;\n\n            default:\n              break;\n          }\n        }\n\n        if (target.children) {\n          target.children.forEach(function (n) {\n            return updateTarget(n);\n          });\n        }\n      };\n\n      updateTarget(diffResult);\n      structures[cfg.id].push(newTarget);\n    },\n    getAnchorPoints: function getAnchorPoints() {\n      return [[0, 0.5], [1, 0.5], [0.5, 1], [0.5, 0]];\n    }\n  };\n}"]},"metadata":{},"sourceType":"module"}