{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { each, isNil, isPlainObject, isString, isBoolean, uniqueId, mix, deepMix } from '@antv/util';\nimport Shape from '../shape/shape';\nimport { getBBox } from '../util/graphic';\nimport { translate } from '../util/math';\nvar CACHE_BBOX = 'bboxCache';\nvar CACHE_CANVAS_BBOX = 'bboxCanvasCache';\n\nvar ItemBase =\n/** @class */\nfunction () {\n  function ItemBase(cfg) {\n    this._cfg = {};\n    this.destroyed = false;\n    var defaultCfg = {\n      /**\n       * id\n       * @type {string}\n       */\n      id: undefined,\n\n      /**\n       * 类型\n       * @type {string}\n       */\n      type: 'item',\n\n      /**\n       * data model\n       * @type {object}\n       */\n      model: {},\n\n      /**\n       * g group\n       * @type {G.Group}\n       */\n      group: undefined,\n\n      /**\n       * is open animate\n       * @type {boolean}\n       */\n      animate: false,\n\n      /**\n       * visible - not group visible\n       * @type {boolean}\n       */\n      visible: true,\n\n      /**\n       * locked - lock node\n       * @type {boolean}\n       */\n      locked: false,\n\n      /**\n       * capture event\n       * @type {boolean}\n       */\n      event: true,\n\n      /**\n       * key shape to calculate item's bbox\n       * @type object\n       */\n      keyShape: undefined,\n\n      /**\n       * item's states, such as selected or active\n       * @type Array\n       */\n      states: []\n    };\n    this._cfg = Object.assign(defaultCfg, this.getDefaultCfg(), cfg);\n    var model = this.get('model');\n    var id = model.id;\n    var itemType = this.get('type');\n\n    if (!id) {\n      id = uniqueId(itemType);\n      this.get('model').id = id;\n    }\n\n    this.set('id', id);\n    var group = cfg.group;\n\n    if (group) {\n      group.set('item', this);\n      group.set('id', id);\n    }\n\n    this.init();\n    this.draw();\n    var shapeType = model.shape || model.type || (itemType === 'edge' ? 'line' : 'circle');\n    var shapeFactory = this.get('shapeFactory');\n\n    if (shapeFactory && shapeFactory[shapeType]) {\n      var options = shapeFactory[shapeType].options; // merge the stateStyles from item and shape\n\n      if (options && options.stateStyles) {\n        var styles = this.get('styles') || model.stateStyles;\n        styles = deepMix({}, options.stateStyles, styles);\n        this.set('styles', styles);\n      }\n    }\n  }\n  /**\n   * 根据 keyshape 计算包围盒\n   */\n\n\n  ItemBase.prototype.calculateBBox = function () {\n    var keyShape = this.get('keyShape');\n    var group = this.get('group'); // 因为 group 可能会移动，所以必须通过父元素计算才能计算出正确的包围盒\n\n    var bbox = getBBox(keyShape, group);\n    bbox.x = bbox.minX;\n    bbox.y = bbox.minY;\n    bbox.width = bbox.maxX - bbox.minX;\n    bbox.height = bbox.maxY - bbox.minY;\n    bbox.centerX = (bbox.minX + bbox.maxX) / 2;\n    bbox.centerY = (bbox.minY + bbox.maxY) / 2;\n    return bbox;\n  };\n  /**\n   * 根据 keyshape 计算包围盒\n   */\n\n\n  ItemBase.prototype.calculateCanvasBBox = function () {\n    var keyShape = this.get('keyShape');\n    var group = this.get('group'); // 因为 group 可能会移动，所以必须通过父元素计算才能计算出正确的包围盒\n\n    var bbox = getBBox(keyShape, group);\n    bbox.x = bbox.minX;\n    bbox.y = bbox.minY;\n    bbox.width = bbox.maxX - bbox.minX;\n    bbox.height = bbox.maxY - bbox.minY;\n    bbox.centerX = (bbox.minX + bbox.maxX) / 2;\n    bbox.centerY = (bbox.minY + bbox.maxY) / 2;\n    return bbox;\n  };\n  /**\n   * draw shape\n   */\n\n\n  ItemBase.prototype.drawInner = function () {\n    var self = this;\n    var shapeFactory = self.get('shapeFactory');\n    var group = self.get('group');\n    var model = self.get('model');\n    group.clear();\n    var visible = model.visible;\n    if (visible !== undefined && !visible) self.changeVisibility(visible);\n\n    if (!shapeFactory) {\n      return;\n    }\n\n    self.updatePosition(model);\n    var cfg = self.getShapeCfg(model); // 可能会附加额外信息\n\n    var shapeType = cfg.shape || cfg.type;\n    var keyShape = shapeFactory.draw(shapeType, cfg, group);\n\n    if (keyShape) {\n      self.set('keyShape', keyShape);\n      keyShape.set('isKeyShape', true);\n      keyShape.set('draggable', true);\n    }\n\n    this.setOriginStyle(); // 防止由于用户外部修改 model 中的 shape 导致 shape 不更新\n\n    this.set('currentShape', shapeType);\n    this.restoreStates(shapeFactory, shapeType);\n  };\n  /**\n   * 设置图元素原始样式\n   * @param keyShape 图元素 keyShape\n   * @param group Group 容器\n   */\n\n\n  ItemBase.prototype.setOriginStyle = function (cfg) {\n    var originStyles = {};\n    var group = this.get('group');\n    var children = group.get('children');\n    var keyShape = this.getKeyShape();\n    var self = this;\n    each(children, function (child) {\n      var name = child.get('name');\n\n      if (name) {\n        originStyles[name] = self.getShapeStyleByName(name);\n      } else {\n        var keyShapeName = keyShape.get('name');\n        var keyShapeStyle = self.getShapeStyleByName();\n\n        if (!keyShapeName) {\n          Object.assign(originStyles, keyShapeStyle);\n        } else {\n          originStyles[keyShapeName] = keyShapeStyle;\n        }\n      }\n    });\n    var drawOriginStyle = this.getOriginStyle();\n    var styles = {};\n\n    if (cfg) {\n      styles = deepMix({}, drawOriginStyle, originStyles, cfg.style, {\n        labelCfg: cfg.labelCfg\n      });\n    } else {\n      styles = deepMix({}, drawOriginStyle, originStyles);\n    }\n\n    self.set('originStyle', styles);\n  };\n  /**\n   * restore shape states\n   * @param shapeFactory\n   * @param shapeType\n   */\n\n\n  ItemBase.prototype.restoreStates = function (shapeFactory, shapeType) {\n    var self = this;\n    var states = self.get('states');\n    each(states, function (state) {\n      shapeFactory.setState(shapeType, state, true, self);\n    });\n  };\n\n  ItemBase.prototype.init = function () {\n    var shapeFactory = Shape.getFactory(this.get('type'));\n    this.set('shapeFactory', shapeFactory);\n  };\n  /**\n   * 获取属性\n   * @internal 仅内部类使用\n   * @param  {String} key 属性名\n   * @return {object | string | number} 属性值\n   */\n\n\n  ItemBase.prototype.get = function (key) {\n    return this._cfg[key];\n  };\n  /**\n   * 设置属性\n   * @internal 仅内部类使用\n   * @param {String|Object} key 属性名，也可以是对象\n   * @param {object | string | number} val 属性值\n   */\n\n\n  ItemBase.prototype.set = function (key, val) {\n    if (isPlainObject(key)) {\n      this._cfg = __assign(__assign({}, this._cfg), key);\n    } else {\n      this._cfg[key] = val;\n    }\n  };\n\n  ItemBase.prototype.getDefaultCfg = function () {\n    return {};\n  };\n  /**\n   * 更新/刷新等操作后，清除 cache\n   */\n\n\n  ItemBase.prototype.clearCache = function () {\n    this.set(CACHE_BBOX, null);\n    this.set(CACHE_CANVAS_BBOX, null);\n  };\n  /**\n   * 渲染前的逻辑，提供给子类复写\n   */\n\n\n  ItemBase.prototype.beforeDraw = function () {};\n  /**\n   * 渲染后的逻辑，提供给子类复写\n   */\n\n\n  ItemBase.prototype.afterDraw = function () {};\n  /**\n   * 更新后做一些工作\n   */\n\n\n  ItemBase.prototype.afterUpdate = function () {};\n  /**\n   * draw shape\n   */\n\n\n  ItemBase.prototype.draw = function () {\n    this.beforeDraw();\n    this.drawInner();\n    this.afterDraw();\n  };\n\n  ItemBase.prototype.getShapeStyleByName = function (name) {\n    var group = this.get('group');\n    var currentShape = this.getKeyShape();\n\n    if (name) {\n      currentShape = group.find(function (element) {\n        return element.get('name') === name;\n      });\n    }\n\n    if (currentShape) {\n      var styles_1 = {};\n      each(currentShape.attr(), function (val, key) {\n        // 修改 img 通过 updateItem 实现\n        if (key !== 'img') {\n          styles_1[key] = val;\n        }\n      });\n      return styles_1;\n    }\n\n    return {};\n  };\n\n  ItemBase.prototype.getShapeCfg = function (model) {\n    var styles = this.get('styles');\n\n    if (styles) {\n      // merge graph的item样式与数据模型中的样式\n      var newModel = model;\n      newModel.style = __assign(__assign({}, styles), model.style);\n      return newModel;\n    }\n\n    return model;\n  };\n  /**\n   * 获取指定状态的样式，去除了全局样式\n   * @param state 状态名称\n   */\n\n\n  ItemBase.prototype.getStateStyle = function (state) {\n    var styles = this.get('styles');\n    var stateStyle = styles && styles[state];\n    return stateStyle;\n  };\n  /**\n   * get keyshape style\n   */\n\n\n  ItemBase.prototype.getOriginStyle = function () {\n    return this.get('originStyle');\n  };\n\n  ItemBase.prototype.getCurrentStatesStyle = function () {\n    var self = this;\n    var styles = {};\n    each(self.getStates(), function (state) {\n      styles = Object.assign(styles, self.getStateStyle(state));\n    });\n    return styles;\n  };\n  /**\n   * 更改元素状态， visible 不属于这个范畴\n   * @internal 仅提供内部类 graph 使用\n   * @param {String} state 状态名\n   * @param {Boolean} value 节点状态值\n   */\n\n\n  ItemBase.prototype.setState = function (state, value) {\n    var states = this.get('states');\n    var shapeFactory = this.get('shapeFactory');\n    var stateName = state;\n    var filterStateName = state;\n\n    if (isString(value)) {\n      stateName = state + \":\" + value;\n      filterStateName = state + \":\";\n    }\n\n    var newStates = states;\n\n    if (isBoolean(value)) {\n      var index = states.indexOf(filterStateName);\n\n      if (value) {\n        if (index > -1) {\n          return;\n        }\n\n        states.push(stateName);\n      } else if (index > -1) {\n        states.splice(index, 1);\n      }\n    } else if (isString(value)) {\n      // 过滤掉 states 中 filterStateName 相关的状态\n      var filterStates = states.filter(function (name) {\n        return name.includes(filterStateName);\n      });\n\n      if (filterStates.length > 0) {\n        this.clearStates(filterStates);\n      }\n\n      newStates = newStates.filter(function (name) {\n        return !name.includes(filterStateName);\n      });\n      newStates.push(stateName);\n      this.set('states', newStates);\n    }\n\n    if (shapeFactory) {\n      var model = this.get('model');\n      var type = model.shape || model.type; // 调用 shape/shape.ts 中的 setState\n\n      shapeFactory.setState(type, state, value, this);\n    }\n  };\n  /**\n   * 清除指定的状态，如果参数为空，则不做任务处理\n   * @param states 状态名称\n   */\n\n\n  ItemBase.prototype.clearStates = function (states) {\n    var self = this;\n    var originStates = self.getStates();\n    var shapeFactory = self.get('shapeFactory');\n    var model = self.get('model');\n    var shape = model.shape || model.type;\n\n    if (!states) {\n      states = originStates;\n    }\n\n    if (isString(states)) {\n      states = [states];\n    }\n\n    var newStates = originStates.filter(function (state) {\n      return states.indexOf(state) === -1;\n    });\n    self.set('states', newStates);\n    states.forEach(function (state) {\n      shapeFactory.setState(shape, state, false, self);\n    });\n  };\n  /**\n   * 节点的图形容器\n   * @return {G.Group} 图形容器\n   */\n\n\n  ItemBase.prototype.getContainer = function () {\n    return this.get('group');\n  };\n  /**\n   * 节点的关键形状，用于计算节点大小，连线截距等\n   * @return {IShapeBase} 关键形状\n   */\n\n\n  ItemBase.prototype.getKeyShape = function () {\n    return this.get('keyShape');\n  };\n  /**\n   * 节点数据模型\n   * @return {Object} 数据模型\n   */\n\n\n  ItemBase.prototype.getModel = function () {\n    return this.get('model');\n  };\n  /**\n   * 节点类型\n   * @return {string} 节点的类型\n   */\n\n\n  ItemBase.prototype.getType = function () {\n    return this.get('type');\n  };\n  /**\n   * 获取 Item 的ID\n   */\n\n\n  ItemBase.prototype.getID = function () {\n    return this.get('id');\n  };\n  /**\n   * 是否是 Item 对象，悬空边情况下进行判定\n   */\n\n\n  ItemBase.prototype.isItem = function () {\n    return true;\n  };\n  /**\n   * 获取当前元素的所有状态\n   * @return {Array} 元素的所有状态\n   */\n\n\n  ItemBase.prototype.getStates = function () {\n    return this.get('states');\n  };\n  /**\n   * 当前元素是否处于某状态\n   * @param {String} state 状态名\n   * @return {Boolean} 是否处于某状态\n   */\n\n\n  ItemBase.prototype.hasState = function (state) {\n    var states = this.getStates();\n    return states.indexOf(state) >= 0;\n  };\n  /**\n   * 刷新一般用于处理几种情况\n   * 1. item model 在外部被改变\n   * 2. 边的节点位置发生改变，需要重新计算边\n   *\n   * 因为数据从外部被修改无法判断一些属性是否被修改，直接走位置和 shape 的更新\n   */\n\n\n  ItemBase.prototype.refresh = function () {\n    var model = this.get('model'); // 更新元素位置\n\n    this.updatePosition(model); // 更新元素内容，样式\n\n    this.updateShape(); // 做一些更新之后的操作\n\n    this.afterUpdate(); // 清除缓存\n\n    this.clearCache();\n  };\n\n  ItemBase.prototype.isOnlyMove = function (cfg) {\n    return false;\n  };\n  /**\n   * 将更新应用到 model 上，刷新属性\n   * @internal 仅提供给 Graph 使用，外部直接调用 graph.update 接口\n   * @param  {Object} cfg       配置项，可以是增量信息\n   */\n\n\n  ItemBase.prototype.update = function (cfg) {\n    var model = this.get('model');\n    var oriVisible = model.visible;\n    var cfgVisible = cfg.visible;\n    if (oriVisible !== cfgVisible && cfgVisible !== undefined) this.changeVisibility(cfgVisible);\n    var originPosition = {\n      x: model.x,\n      y: model.y\n    };\n    cfg.x = isNaN(cfg.x) ? model.x : cfg.x;\n    cfg.y = isNaN(cfg.y) ? model.y : cfg.y;\n    var styles = this.get('styles');\n\n    if (cfg.stateStyles) {\n      // 更新 item 时更新 this.get('styles') 中的值\n      var stateStyles = cfg.stateStyles;\n      mix(styles, stateStyles);\n      delete cfg.stateStyles;\n    } // 直接将更新合到原数据模型上，可以保证用户在外部修改源数据然后刷新时的样式符合期待。\n\n\n    Object.assign(model, cfg); // isOnlyMove 仅用于node\n\n    var onlyMove = this.isOnlyMove(cfg); // 仅仅移动位置时，既不更新，也不重绘\n\n    if (onlyMove) {\n      this.updatePosition(cfg);\n    } else {\n      // 如果 x,y 有变化，先重置位置\n      if (originPosition.x !== cfg.x || originPosition.y !== cfg.y) {\n        this.updatePosition(cfg);\n      }\n\n      this.updateShape();\n    }\n\n    this.afterUpdate();\n    this.clearCache();\n  };\n  /**\n   * 更新元素内容，样式\n   */\n\n\n  ItemBase.prototype.updateShape = function () {\n    var shapeFactory = this.get('shapeFactory');\n    var model = this.get('model');\n    var shape = model.shape || model.type; // 判定是否允许更新\n    // 1. 注册的节点允许更新\n    // 2. 更新后的 shape 等于原先的 shape\n\n    if (shapeFactory.shouldUpdate(shape) && shape === this.get('currentShape')) {\n      var updateCfg = this.getShapeCfg(model);\n      shapeFactory.baseUpdate(shape, updateCfg, this);\n    } else {\n      // 如果不满足上面两种状态，重新绘制\n      this.draw();\n    } // 更新完以后重新设置原始样式\n\n\n    this.setOriginStyle(model); // 更新后重置节点状态\n\n    this.restoreStates(shapeFactory, shape);\n  };\n  /**\n   * 更新位置，避免整体重绘\n   * @param {object} cfg 待更新数据\n   */\n\n\n  ItemBase.prototype.updatePosition = function (cfg) {\n    var model = this.get('model');\n    var x = isNil(cfg.x) ? model.x : cfg.x;\n    var y = isNil(cfg.y) ? model.y : cfg.y;\n    var group = this.get('group');\n\n    if (isNil(x) || isNil(y)) {\n      return;\n    }\n\n    group.resetMatrix(); // G 4.0 element 中移除了矩阵相关方法，详见https://www.yuque.com/antv/blog/kxzk9g#4rMMV\n\n    translate(group, {\n      x: x,\n      y: y\n    });\n    model.x = x;\n    model.y = y;\n    this.clearCache(); // 位置更新后需要清除缓存\n  };\n  /**\n   * 获取 item 的包围盒，这个包围盒是相对于 item 自己，不会将 matrix 计算在内\n   * @return {Object} 包含 x,y,width,height, centerX, centerY\n   */\n\n\n  ItemBase.prototype.getBBox = function () {\n    // 计算 bbox 开销有些大，缓存\n    var bbox = this.get(CACHE_BBOX);\n\n    if (!bbox) {\n      bbox = this.calculateBBox();\n      this.set(CACHE_BBOX, bbox);\n    }\n\n    return bbox;\n  };\n  /**\n   * 获取 item 相对于画布的包围盒，会将从顶层到当前元素的 matrix 都计算在内\n   * @return {Object} 包含 x,y,width,height, centerX, centerY\n   */\n\n\n  ItemBase.prototype.getCanvasBBox = function () {\n    // 计算 bbox 开销有些大，缓存\n    var bbox = this.get(CACHE_CANVAS_BBOX);\n\n    if (!bbox) {\n      bbox = this.calculateCanvasBBox();\n      this.set(CACHE_CANVAS_BBOX, bbox);\n    }\n\n    return bbox;\n  };\n  /**\n   * 将元素放到最前面\n   */\n\n\n  ItemBase.prototype.toFront = function () {\n    var group = this.get('group');\n    group.toFront();\n  };\n  /**\n   * 将元素放到最后面\n   */\n\n\n  ItemBase.prototype.toBack = function () {\n    var group = this.get('group');\n    group.toBack();\n  };\n  /**\n   * 显示元素\n   */\n\n\n  ItemBase.prototype.show = function () {\n    this.changeVisibility(true);\n  };\n  /**\n   * 隐藏元素\n   */\n\n\n  ItemBase.prototype.hide = function () {\n    this.changeVisibility(false);\n  };\n  /**\n   * 更改是否显示\n   * @param  {Boolean} visible 是否显示\n   */\n\n\n  ItemBase.prototype.changeVisibility = function (visible) {\n    var group = this.get('group');\n\n    if (visible) {\n      group.show();\n    } else {\n      group.hide();\n    }\n\n    this.set('visible', visible);\n  };\n  /**\n   * 元素是否可见\n   * @return {Boolean} 返回该元素是否可见\n   */\n\n\n  ItemBase.prototype.isVisible = function () {\n    return this.get('visible');\n  };\n  /**\n   * 是否拾取及出发该元素的交互事件\n   * @param {Boolean} enable 标识位\n   */\n\n\n  ItemBase.prototype.enableCapture = function (enable) {\n    var group = this.get('group');\n\n    if (group) {\n      group.set('capture', enable);\n    }\n  };\n\n  ItemBase.prototype.destroy = function () {\n    if (!this.destroyed) {\n      var animate = this.get('animate');\n      var group = this.get('group');\n\n      if (animate) {\n        group.stopAnimate();\n      }\n\n      this.clearCache();\n      group.remove();\n      this._cfg = null;\n      this.destroyed = true;\n    }\n  };\n\n  return ItemBase;\n}();\n\nexport default ItemBase;","map":{"version":3,"sources":["/Users/wanglijie/wanglijie/clover-defi-wallet/node_modules/@antv/g6/es/item/item.js"],"names":["__assign","each","isNil","isPlainObject","isString","isBoolean","uniqueId","mix","deepMix","Shape","getBBox","translate","CACHE_BBOX","CACHE_CANVAS_BBOX","ItemBase","cfg","_cfg","destroyed","defaultCfg","id","undefined","type","model","group","animate","visible","locked","event","keyShape","states","Object","assign","getDefaultCfg","get","itemType","set","init","draw","shapeType","shape","shapeFactory","options","stateStyles","styles","prototype","calculateBBox","bbox","x","minX","y","minY","width","maxX","height","maxY","centerX","centerY","calculateCanvasBBox","drawInner","self","clear","changeVisibility","updatePosition","getShapeCfg","setOriginStyle","restoreStates","originStyles","children","getKeyShape","child","name","getShapeStyleByName","keyShapeName","keyShapeStyle","drawOriginStyle","getOriginStyle","style","labelCfg","state","setState","getFactory","key","val","clearCache","beforeDraw","afterDraw","afterUpdate","currentShape","find","element","styles_1","attr","newModel","getStateStyle","stateStyle","getCurrentStatesStyle","getStates","value","stateName","filterStateName","newStates","index","indexOf","push","splice","filterStates","filter","includes","length","clearStates","originStates","forEach","getContainer","getModel","getType","getID","isItem","hasState","refresh","updateShape","isOnlyMove","update","oriVisible","cfgVisible","originPosition","isNaN","onlyMove","shouldUpdate","updateCfg","baseUpdate","resetMatrix","getCanvasBBox","toFront","toBack","show","hide","isVisible","enableCapture","enable","destroy","stopAnimate","remove"],"mappings":"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","sourcesContent":["import { __assign } from \"tslib\";\nimport { each, isNil, isPlainObject, isString, isBoolean, uniqueId, mix, deepMix } from '@antv/util';\nimport Shape from '../shape/shape';\nimport { getBBox } from '../util/graphic';\nimport { translate } from '../util/math';\nvar CACHE_BBOX = 'bboxCache';\nvar CACHE_CANVAS_BBOX = 'bboxCanvasCache';\n\nvar ItemBase =\n/** @class */\nfunction () {\n  function ItemBase(cfg) {\n    this._cfg = {};\n    this.destroyed = false;\n    var defaultCfg = {\n      /**\n       * id\n       * @type {string}\n       */\n      id: undefined,\n\n      /**\n       * 类型\n       * @type {string}\n       */\n      type: 'item',\n\n      /**\n       * data model\n       * @type {object}\n       */\n      model: {},\n\n      /**\n       * g group\n       * @type {G.Group}\n       */\n      group: undefined,\n\n      /**\n       * is open animate\n       * @type {boolean}\n       */\n      animate: false,\n\n      /**\n       * visible - not group visible\n       * @type {boolean}\n       */\n      visible: true,\n\n      /**\n       * locked - lock node\n       * @type {boolean}\n       */\n      locked: false,\n\n      /**\n       * capture event\n       * @type {boolean}\n       */\n      event: true,\n\n      /**\n       * key shape to calculate item's bbox\n       * @type object\n       */\n      keyShape: undefined,\n\n      /**\n       * item's states, such as selected or active\n       * @type Array\n       */\n      states: []\n    };\n    this._cfg = Object.assign(defaultCfg, this.getDefaultCfg(), cfg);\n    var model = this.get('model');\n    var id = model.id;\n    var itemType = this.get('type');\n\n    if (!id) {\n      id = uniqueId(itemType);\n      this.get('model').id = id;\n    }\n\n    this.set('id', id);\n    var group = cfg.group;\n\n    if (group) {\n      group.set('item', this);\n      group.set('id', id);\n    }\n\n    this.init();\n    this.draw();\n    var shapeType = model.shape || model.type || (itemType === 'edge' ? 'line' : 'circle');\n    var shapeFactory = this.get('shapeFactory');\n\n    if (shapeFactory && shapeFactory[shapeType]) {\n      var options = shapeFactory[shapeType].options; // merge the stateStyles from item and shape\n\n      if (options && options.stateStyles) {\n        var styles = this.get('styles') || model.stateStyles;\n        styles = deepMix({}, options.stateStyles, styles);\n        this.set('styles', styles);\n      }\n    }\n  }\n  /**\n   * 根据 keyshape 计算包围盒\n   */\n\n\n  ItemBase.prototype.calculateBBox = function () {\n    var keyShape = this.get('keyShape');\n    var group = this.get('group'); // 因为 group 可能会移动，所以必须通过父元素计算才能计算出正确的包围盒\n\n    var bbox = getBBox(keyShape, group);\n    bbox.x = bbox.minX;\n    bbox.y = bbox.minY;\n    bbox.width = bbox.maxX - bbox.minX;\n    bbox.height = bbox.maxY - bbox.minY;\n    bbox.centerX = (bbox.minX + bbox.maxX) / 2;\n    bbox.centerY = (bbox.minY + bbox.maxY) / 2;\n    return bbox;\n  };\n  /**\n   * 根据 keyshape 计算包围盒\n   */\n\n\n  ItemBase.prototype.calculateCanvasBBox = function () {\n    var keyShape = this.get('keyShape');\n    var group = this.get('group'); // 因为 group 可能会移动，所以必须通过父元素计算才能计算出正确的包围盒\n\n    var bbox = getBBox(keyShape, group);\n    bbox.x = bbox.minX;\n    bbox.y = bbox.minY;\n    bbox.width = bbox.maxX - bbox.minX;\n    bbox.height = bbox.maxY - bbox.minY;\n    bbox.centerX = (bbox.minX + bbox.maxX) / 2;\n    bbox.centerY = (bbox.minY + bbox.maxY) / 2;\n    return bbox;\n  };\n  /**\n   * draw shape\n   */\n\n\n  ItemBase.prototype.drawInner = function () {\n    var self = this;\n    var shapeFactory = self.get('shapeFactory');\n    var group = self.get('group');\n    var model = self.get('model');\n    group.clear();\n    var visible = model.visible;\n    if (visible !== undefined && !visible) self.changeVisibility(visible);\n\n    if (!shapeFactory) {\n      return;\n    }\n\n    self.updatePosition(model);\n    var cfg = self.getShapeCfg(model); // 可能会附加额外信息\n\n    var shapeType = cfg.shape || cfg.type;\n    var keyShape = shapeFactory.draw(shapeType, cfg, group);\n\n    if (keyShape) {\n      self.set('keyShape', keyShape);\n      keyShape.set('isKeyShape', true);\n      keyShape.set('draggable', true);\n    }\n\n    this.setOriginStyle(); // 防止由于用户外部修改 model 中的 shape 导致 shape 不更新\n\n    this.set('currentShape', shapeType);\n    this.restoreStates(shapeFactory, shapeType);\n  };\n  /**\n   * 设置图元素原始样式\n   * @param keyShape 图元素 keyShape\n   * @param group Group 容器\n   */\n\n\n  ItemBase.prototype.setOriginStyle = function (cfg) {\n    var originStyles = {};\n    var group = this.get('group');\n    var children = group.get('children');\n    var keyShape = this.getKeyShape();\n    var self = this;\n    each(children, function (child) {\n      var name = child.get('name');\n\n      if (name) {\n        originStyles[name] = self.getShapeStyleByName(name);\n      } else {\n        var keyShapeName = keyShape.get('name');\n        var keyShapeStyle = self.getShapeStyleByName();\n\n        if (!keyShapeName) {\n          Object.assign(originStyles, keyShapeStyle);\n        } else {\n          originStyles[keyShapeName] = keyShapeStyle;\n        }\n      }\n    });\n    var drawOriginStyle = this.getOriginStyle();\n    var styles = {};\n\n    if (cfg) {\n      styles = deepMix({}, drawOriginStyle, originStyles, cfg.style, {\n        labelCfg: cfg.labelCfg\n      });\n    } else {\n      styles = deepMix({}, drawOriginStyle, originStyles);\n    }\n\n    self.set('originStyle', styles);\n  };\n  /**\n   * restore shape states\n   * @param shapeFactory\n   * @param shapeType\n   */\n\n\n  ItemBase.prototype.restoreStates = function (shapeFactory, shapeType) {\n    var self = this;\n    var states = self.get('states');\n    each(states, function (state) {\n      shapeFactory.setState(shapeType, state, true, self);\n    });\n  };\n\n  ItemBase.prototype.init = function () {\n    var shapeFactory = Shape.getFactory(this.get('type'));\n    this.set('shapeFactory', shapeFactory);\n  };\n  /**\n   * 获取属性\n   * @internal 仅内部类使用\n   * @param  {String} key 属性名\n   * @return {object | string | number} 属性值\n   */\n\n\n  ItemBase.prototype.get = function (key) {\n    return this._cfg[key];\n  };\n  /**\n   * 设置属性\n   * @internal 仅内部类使用\n   * @param {String|Object} key 属性名，也可以是对象\n   * @param {object | string | number} val 属性值\n   */\n\n\n  ItemBase.prototype.set = function (key, val) {\n    if (isPlainObject(key)) {\n      this._cfg = __assign(__assign({}, this._cfg), key);\n    } else {\n      this._cfg[key] = val;\n    }\n  };\n\n  ItemBase.prototype.getDefaultCfg = function () {\n    return {};\n  };\n  /**\n   * 更新/刷新等操作后，清除 cache\n   */\n\n\n  ItemBase.prototype.clearCache = function () {\n    this.set(CACHE_BBOX, null);\n    this.set(CACHE_CANVAS_BBOX, null);\n  };\n  /**\n   * 渲染前的逻辑，提供给子类复写\n   */\n\n\n  ItemBase.prototype.beforeDraw = function () {};\n  /**\n   * 渲染后的逻辑，提供给子类复写\n   */\n\n\n  ItemBase.prototype.afterDraw = function () {};\n  /**\n   * 更新后做一些工作\n   */\n\n\n  ItemBase.prototype.afterUpdate = function () {};\n  /**\n   * draw shape\n   */\n\n\n  ItemBase.prototype.draw = function () {\n    this.beforeDraw();\n    this.drawInner();\n    this.afterDraw();\n  };\n\n  ItemBase.prototype.getShapeStyleByName = function (name) {\n    var group = this.get('group');\n    var currentShape = this.getKeyShape();\n\n    if (name) {\n      currentShape = group.find(function (element) {\n        return element.get('name') === name;\n      });\n    }\n\n    if (currentShape) {\n      var styles_1 = {};\n      each(currentShape.attr(), function (val, key) {\n        // 修改 img 通过 updateItem 实现\n        if (key !== 'img') {\n          styles_1[key] = val;\n        }\n      });\n      return styles_1;\n    }\n\n    return {};\n  };\n\n  ItemBase.prototype.getShapeCfg = function (model) {\n    var styles = this.get('styles');\n\n    if (styles) {\n      // merge graph的item样式与数据模型中的样式\n      var newModel = model;\n      newModel.style = __assign(__assign({}, styles), model.style);\n      return newModel;\n    }\n\n    return model;\n  };\n  /**\n   * 获取指定状态的样式，去除了全局样式\n   * @param state 状态名称\n   */\n\n\n  ItemBase.prototype.getStateStyle = function (state) {\n    var styles = this.get('styles');\n    var stateStyle = styles && styles[state];\n    return stateStyle;\n  };\n  /**\n   * get keyshape style\n   */\n\n\n  ItemBase.prototype.getOriginStyle = function () {\n    return this.get('originStyle');\n  };\n\n  ItemBase.prototype.getCurrentStatesStyle = function () {\n    var self = this;\n    var styles = {};\n    each(self.getStates(), function (state) {\n      styles = Object.assign(styles, self.getStateStyle(state));\n    });\n    return styles;\n  };\n  /**\n   * 更改元素状态， visible 不属于这个范畴\n   * @internal 仅提供内部类 graph 使用\n   * @param {String} state 状态名\n   * @param {Boolean} value 节点状态值\n   */\n\n\n  ItemBase.prototype.setState = function (state, value) {\n    var states = this.get('states');\n    var shapeFactory = this.get('shapeFactory');\n    var stateName = state;\n    var filterStateName = state;\n\n    if (isString(value)) {\n      stateName = state + \":\" + value;\n      filterStateName = state + \":\";\n    }\n\n    var newStates = states;\n\n    if (isBoolean(value)) {\n      var index = states.indexOf(filterStateName);\n\n      if (value) {\n        if (index > -1) {\n          return;\n        }\n\n        states.push(stateName);\n      } else if (index > -1) {\n        states.splice(index, 1);\n      }\n    } else if (isString(value)) {\n      // 过滤掉 states 中 filterStateName 相关的状态\n      var filterStates = states.filter(function (name) {\n        return name.includes(filterStateName);\n      });\n\n      if (filterStates.length > 0) {\n        this.clearStates(filterStates);\n      }\n\n      newStates = newStates.filter(function (name) {\n        return !name.includes(filterStateName);\n      });\n      newStates.push(stateName);\n      this.set('states', newStates);\n    }\n\n    if (shapeFactory) {\n      var model = this.get('model');\n      var type = model.shape || model.type; // 调用 shape/shape.ts 中的 setState\n\n      shapeFactory.setState(type, state, value, this);\n    }\n  };\n  /**\n   * 清除指定的状态，如果参数为空，则不做任务处理\n   * @param states 状态名称\n   */\n\n\n  ItemBase.prototype.clearStates = function (states) {\n    var self = this;\n    var originStates = self.getStates();\n    var shapeFactory = self.get('shapeFactory');\n    var model = self.get('model');\n    var shape = model.shape || model.type;\n\n    if (!states) {\n      states = originStates;\n    }\n\n    if (isString(states)) {\n      states = [states];\n    }\n\n    var newStates = originStates.filter(function (state) {\n      return states.indexOf(state) === -1;\n    });\n    self.set('states', newStates);\n    states.forEach(function (state) {\n      shapeFactory.setState(shape, state, false, self);\n    });\n  };\n  /**\n   * 节点的图形容器\n   * @return {G.Group} 图形容器\n   */\n\n\n  ItemBase.prototype.getContainer = function () {\n    return this.get('group');\n  };\n  /**\n   * 节点的关键形状，用于计算节点大小，连线截距等\n   * @return {IShapeBase} 关键形状\n   */\n\n\n  ItemBase.prototype.getKeyShape = function () {\n    return this.get('keyShape');\n  };\n  /**\n   * 节点数据模型\n   * @return {Object} 数据模型\n   */\n\n\n  ItemBase.prototype.getModel = function () {\n    return this.get('model');\n  };\n  /**\n   * 节点类型\n   * @return {string} 节点的类型\n   */\n\n\n  ItemBase.prototype.getType = function () {\n    return this.get('type');\n  };\n  /**\n   * 获取 Item 的ID\n   */\n\n\n  ItemBase.prototype.getID = function () {\n    return this.get('id');\n  };\n  /**\n   * 是否是 Item 对象，悬空边情况下进行判定\n   */\n\n\n  ItemBase.prototype.isItem = function () {\n    return true;\n  };\n  /**\n   * 获取当前元素的所有状态\n   * @return {Array} 元素的所有状态\n   */\n\n\n  ItemBase.prototype.getStates = function () {\n    return this.get('states');\n  };\n  /**\n   * 当前元素是否处于某状态\n   * @param {String} state 状态名\n   * @return {Boolean} 是否处于某状态\n   */\n\n\n  ItemBase.prototype.hasState = function (state) {\n    var states = this.getStates();\n    return states.indexOf(state) >= 0;\n  };\n  /**\n   * 刷新一般用于处理几种情况\n   * 1. item model 在外部被改变\n   * 2. 边的节点位置发生改变，需要重新计算边\n   *\n   * 因为数据从外部被修改无法判断一些属性是否被修改，直接走位置和 shape 的更新\n   */\n\n\n  ItemBase.prototype.refresh = function () {\n    var model = this.get('model'); // 更新元素位置\n\n    this.updatePosition(model); // 更新元素内容，样式\n\n    this.updateShape(); // 做一些更新之后的操作\n\n    this.afterUpdate(); // 清除缓存\n\n    this.clearCache();\n  };\n\n  ItemBase.prototype.isOnlyMove = function (cfg) {\n    return false;\n  };\n  /**\n   * 将更新应用到 model 上，刷新属性\n   * @internal 仅提供给 Graph 使用，外部直接调用 graph.update 接口\n   * @param  {Object} cfg       配置项，可以是增量信息\n   */\n\n\n  ItemBase.prototype.update = function (cfg) {\n    var model = this.get('model');\n    var oriVisible = model.visible;\n    var cfgVisible = cfg.visible;\n    if (oriVisible !== cfgVisible && cfgVisible !== undefined) this.changeVisibility(cfgVisible);\n    var originPosition = {\n      x: model.x,\n      y: model.y\n    };\n    cfg.x = isNaN(cfg.x) ? model.x : cfg.x;\n    cfg.y = isNaN(cfg.y) ? model.y : cfg.y;\n    var styles = this.get('styles');\n\n    if (cfg.stateStyles) {\n      // 更新 item 时更新 this.get('styles') 中的值\n      var stateStyles = cfg.stateStyles;\n      mix(styles, stateStyles);\n      delete cfg.stateStyles;\n    } // 直接将更新合到原数据模型上，可以保证用户在外部修改源数据然后刷新时的样式符合期待。\n\n\n    Object.assign(model, cfg); // isOnlyMove 仅用于node\n\n    var onlyMove = this.isOnlyMove(cfg); // 仅仅移动位置时，既不更新，也不重绘\n\n    if (onlyMove) {\n      this.updatePosition(cfg);\n    } else {\n      // 如果 x,y 有变化，先重置位置\n      if (originPosition.x !== cfg.x || originPosition.y !== cfg.y) {\n        this.updatePosition(cfg);\n      }\n\n      this.updateShape();\n    }\n\n    this.afterUpdate();\n    this.clearCache();\n  };\n  /**\n   * 更新元素内容，样式\n   */\n\n\n  ItemBase.prototype.updateShape = function () {\n    var shapeFactory = this.get('shapeFactory');\n    var model = this.get('model');\n    var shape = model.shape || model.type; // 判定是否允许更新\n    // 1. 注册的节点允许更新\n    // 2. 更新后的 shape 等于原先的 shape\n\n    if (shapeFactory.shouldUpdate(shape) && shape === this.get('currentShape')) {\n      var updateCfg = this.getShapeCfg(model);\n      shapeFactory.baseUpdate(shape, updateCfg, this);\n    } else {\n      // 如果不满足上面两种状态，重新绘制\n      this.draw();\n    } // 更新完以后重新设置原始样式\n\n\n    this.setOriginStyle(model); // 更新后重置节点状态\n\n    this.restoreStates(shapeFactory, shape);\n  };\n  /**\n   * 更新位置，避免整体重绘\n   * @param {object} cfg 待更新数据\n   */\n\n\n  ItemBase.prototype.updatePosition = function (cfg) {\n    var model = this.get('model');\n    var x = isNil(cfg.x) ? model.x : cfg.x;\n    var y = isNil(cfg.y) ? model.y : cfg.y;\n    var group = this.get('group');\n\n    if (isNil(x) || isNil(y)) {\n      return;\n    }\n\n    group.resetMatrix(); // G 4.0 element 中移除了矩阵相关方法，详见https://www.yuque.com/antv/blog/kxzk9g#4rMMV\n\n    translate(group, {\n      x: x,\n      y: y\n    });\n    model.x = x;\n    model.y = y;\n    this.clearCache(); // 位置更新后需要清除缓存\n  };\n  /**\n   * 获取 item 的包围盒，这个包围盒是相对于 item 自己，不会将 matrix 计算在内\n   * @return {Object} 包含 x,y,width,height, centerX, centerY\n   */\n\n\n  ItemBase.prototype.getBBox = function () {\n    // 计算 bbox 开销有些大，缓存\n    var bbox = this.get(CACHE_BBOX);\n\n    if (!bbox) {\n      bbox = this.calculateBBox();\n      this.set(CACHE_BBOX, bbox);\n    }\n\n    return bbox;\n  };\n  /**\n   * 获取 item 相对于画布的包围盒，会将从顶层到当前元素的 matrix 都计算在内\n   * @return {Object} 包含 x,y,width,height, centerX, centerY\n   */\n\n\n  ItemBase.prototype.getCanvasBBox = function () {\n    // 计算 bbox 开销有些大，缓存\n    var bbox = this.get(CACHE_CANVAS_BBOX);\n\n    if (!bbox) {\n      bbox = this.calculateCanvasBBox();\n      this.set(CACHE_CANVAS_BBOX, bbox);\n    }\n\n    return bbox;\n  };\n  /**\n   * 将元素放到最前面\n   */\n\n\n  ItemBase.prototype.toFront = function () {\n    var group = this.get('group');\n    group.toFront();\n  };\n  /**\n   * 将元素放到最后面\n   */\n\n\n  ItemBase.prototype.toBack = function () {\n    var group = this.get('group');\n    group.toBack();\n  };\n  /**\n   * 显示元素\n   */\n\n\n  ItemBase.prototype.show = function () {\n    this.changeVisibility(true);\n  };\n  /**\n   * 隐藏元素\n   */\n\n\n  ItemBase.prototype.hide = function () {\n    this.changeVisibility(false);\n  };\n  /**\n   * 更改是否显示\n   * @param  {Boolean} visible 是否显示\n   */\n\n\n  ItemBase.prototype.changeVisibility = function (visible) {\n    var group = this.get('group');\n\n    if (visible) {\n      group.show();\n    } else {\n      group.hide();\n    }\n\n    this.set('visible', visible);\n  };\n  /**\n   * 元素是否可见\n   * @return {Boolean} 返回该元素是否可见\n   */\n\n\n  ItemBase.prototype.isVisible = function () {\n    return this.get('visible');\n  };\n  /**\n   * 是否拾取及出发该元素的交互事件\n   * @param {Boolean} enable 标识位\n   */\n\n\n  ItemBase.prototype.enableCapture = function (enable) {\n    var group = this.get('group');\n\n    if (group) {\n      group.set('capture', enable);\n    }\n  };\n\n  ItemBase.prototype.destroy = function () {\n    if (!this.destroyed) {\n      var animate = this.get('animate');\n      var group = this.get('group');\n\n      if (animate) {\n        group.stopAnimate();\n      }\n\n      this.clearCache();\n      group.remove();\n      this._cfg = null;\n      this.destroyed = true;\n    }\n  };\n\n  return ItemBase;\n}();\n\nexport default ItemBase;"]},"metadata":{},"sourceType":"module"}