{"ast":null,"code":"import Matrix from '../matrix';\nimport WrapperMatrix2D from '../wrap/WrapperMatrix2D';\nimport { hypotenuse } from './util';\nexport default class SingularValueDecomposition {\n  constructor(value, options = {}) {\n    value = WrapperMatrix2D.checkMatrix(value);\n    let m = value.rows;\n    let n = value.columns;\n    const {\n      computeLeftSingularVectors = true,\n      computeRightSingularVectors = true,\n      autoTranspose = false\n    } = options;\n    let wantu = Boolean(computeLeftSingularVectors);\n    let wantv = Boolean(computeRightSingularVectors);\n    let swapped = false;\n    let a;\n\n    if (m < n) {\n      if (!autoTranspose) {\n        a = value.clone(); // eslint-disable-next-line no-console\n\n        console.warn('Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose');\n      } else {\n        a = value.transpose();\n        m = a.rows;\n        n = a.columns;\n        swapped = true;\n        let aux = wantu;\n        wantu = wantv;\n        wantv = aux;\n      }\n    } else {\n      a = value.clone();\n    }\n\n    let nu = Math.min(m, n);\n    let ni = Math.min(m + 1, n);\n    let s = new Float64Array(ni);\n    let U = new Matrix(m, nu);\n    let V = new Matrix(n, n);\n    let e = new Float64Array(n);\n    let work = new Float64Array(m);\n    let si = new Float64Array(ni);\n\n    for (let i = 0; i < ni; i++) si[i] = i;\n\n    let nct = Math.min(m - 1, n);\n    let nrt = Math.max(0, Math.min(n - 2, m));\n    let mrc = Math.max(nct, nrt);\n\n    for (let k = 0; k < mrc; k++) {\n      if (k < nct) {\n        s[k] = 0;\n\n        for (let i = k; i < m; i++) {\n          s[k] = hypotenuse(s[k], a.get(i, k));\n        }\n\n        if (s[k] !== 0) {\n          if (a.get(k, k) < 0) {\n            s[k] = -s[k];\n          }\n\n          for (let i = k; i < m; i++) {\n            a.set(i, k, a.get(i, k) / s[k]);\n          }\n\n          a.set(k, k, a.get(k, k) + 1);\n        }\n\n        s[k] = -s[k];\n      }\n\n      for (let j = k + 1; j < n; j++) {\n        if (k < nct && s[k] !== 0) {\n          let t = 0;\n\n          for (let i = k; i < m; i++) {\n            t += a.get(i, k) * a.get(i, j);\n          }\n\n          t = -t / a.get(k, k);\n\n          for (let i = k; i < m; i++) {\n            a.set(i, j, a.get(i, j) + t * a.get(i, k));\n          }\n        }\n\n        e[j] = a.get(k, j);\n      }\n\n      if (wantu && k < nct) {\n        for (let i = k; i < m; i++) {\n          U.set(i, k, a.get(i, k));\n        }\n      }\n\n      if (k < nrt) {\n        e[k] = 0;\n\n        for (let i = k + 1; i < n; i++) {\n          e[k] = hypotenuse(e[k], e[i]);\n        }\n\n        if (e[k] !== 0) {\n          if (e[k + 1] < 0) {\n            e[k] = 0 - e[k];\n          }\n\n          for (let i = k + 1; i < n; i++) {\n            e[i] /= e[k];\n          }\n\n          e[k + 1] += 1;\n        }\n\n        e[k] = -e[k];\n\n        if (k + 1 < m && e[k] !== 0) {\n          for (let i = k + 1; i < m; i++) {\n            work[i] = 0;\n          }\n\n          for (let i = k + 1; i < m; i++) {\n            for (let j = k + 1; j < n; j++) {\n              work[i] += e[j] * a.get(i, j);\n            }\n          }\n\n          for (let j = k + 1; j < n; j++) {\n            let t = -e[j] / e[k + 1];\n\n            for (let i = k + 1; i < m; i++) {\n              a.set(i, j, a.get(i, j) + t * work[i]);\n            }\n          }\n        }\n\n        if (wantv) {\n          for (let i = k + 1; i < n; i++) {\n            V.set(i, k, e[i]);\n          }\n        }\n      }\n    }\n\n    let p = Math.min(n, m + 1);\n\n    if (nct < n) {\n      s[nct] = a.get(nct, nct);\n    }\n\n    if (m < p) {\n      s[p - 1] = 0;\n    }\n\n    if (nrt + 1 < p) {\n      e[nrt] = a.get(nrt, p - 1);\n    }\n\n    e[p - 1] = 0;\n\n    if (wantu) {\n      for (let j = nct; j < nu; j++) {\n        for (let i = 0; i < m; i++) {\n          U.set(i, j, 0);\n        }\n\n        U.set(j, j, 1);\n      }\n\n      for (let k = nct - 1; k >= 0; k--) {\n        if (s[k] !== 0) {\n          for (let j = k + 1; j < nu; j++) {\n            let t = 0;\n\n            for (let i = k; i < m; i++) {\n              t += U.get(i, k) * U.get(i, j);\n            }\n\n            t = -t / U.get(k, k);\n\n            for (let i = k; i < m; i++) {\n              U.set(i, j, U.get(i, j) + t * U.get(i, k));\n            }\n          }\n\n          for (let i = k; i < m; i++) {\n            U.set(i, k, -U.get(i, k));\n          }\n\n          U.set(k, k, 1 + U.get(k, k));\n\n          for (let i = 0; i < k - 1; i++) {\n            U.set(i, k, 0);\n          }\n        } else {\n          for (let i = 0; i < m; i++) {\n            U.set(i, k, 0);\n          }\n\n          U.set(k, k, 1);\n        }\n      }\n    }\n\n    if (wantv) {\n      for (let k = n - 1; k >= 0; k--) {\n        if (k < nrt && e[k] !== 0) {\n          for (let j = k + 1; j < n; j++) {\n            let t = 0;\n\n            for (let i = k + 1; i < n; i++) {\n              t += V.get(i, k) * V.get(i, j);\n            }\n\n            t = -t / V.get(k + 1, k);\n\n            for (let i = k + 1; i < n; i++) {\n              V.set(i, j, V.get(i, j) + t * V.get(i, k));\n            }\n          }\n        }\n\n        for (let i = 0; i < n; i++) {\n          V.set(i, k, 0);\n        }\n\n        V.set(k, k, 1);\n      }\n    }\n\n    let pp = p - 1;\n    let iter = 0;\n    let eps = Number.EPSILON;\n\n    while (p > 0) {\n      let k, kase;\n\n      for (k = p - 2; k >= -1; k--) {\n        if (k === -1) {\n          break;\n        }\n\n        const alpha = Number.MIN_VALUE + eps * Math.abs(s[k] + Math.abs(s[k + 1]));\n\n        if (Math.abs(e[k]) <= alpha || Number.isNaN(e[k])) {\n          e[k] = 0;\n          break;\n        }\n      }\n\n      if (k === p - 2) {\n        kase = 4;\n      } else {\n        let ks;\n\n        for (ks = p - 1; ks >= k; ks--) {\n          if (ks === k) {\n            break;\n          }\n\n          let t = (ks !== p ? Math.abs(e[ks]) : 0) + (ks !== k + 1 ? Math.abs(e[ks - 1]) : 0);\n\n          if (Math.abs(s[ks]) <= eps * t) {\n            s[ks] = 0;\n            break;\n          }\n        }\n\n        if (ks === k) {\n          kase = 3;\n        } else if (ks === p - 1) {\n          kase = 1;\n        } else {\n          kase = 2;\n          k = ks;\n        }\n      }\n\n      k++;\n\n      switch (kase) {\n        case 1:\n          {\n            let f = e[p - 2];\n            e[p - 2] = 0;\n\n            for (let j = p - 2; j >= k; j--) {\n              let t = hypotenuse(s[j], f);\n              let cs = s[j] / t;\n              let sn = f / t;\n              s[j] = t;\n\n              if (j !== k) {\n                f = -sn * e[j - 1];\n                e[j - 1] = cs * e[j - 1];\n              }\n\n              if (wantv) {\n                for (let i = 0; i < n; i++) {\n                  t = cs * V.get(i, j) + sn * V.get(i, p - 1);\n                  V.set(i, p - 1, -sn * V.get(i, j) + cs * V.get(i, p - 1));\n                  V.set(i, j, t);\n                }\n              }\n            }\n\n            break;\n          }\n\n        case 2:\n          {\n            let f = e[k - 1];\n            e[k - 1] = 0;\n\n            for (let j = k; j < p; j++) {\n              let t = hypotenuse(s[j], f);\n              let cs = s[j] / t;\n              let sn = f / t;\n              s[j] = t;\n              f = -sn * e[j];\n              e[j] = cs * e[j];\n\n              if (wantu) {\n                for (let i = 0; i < m; i++) {\n                  t = cs * U.get(i, j) + sn * U.get(i, k - 1);\n                  U.set(i, k - 1, -sn * U.get(i, j) + cs * U.get(i, k - 1));\n                  U.set(i, j, t);\n                }\n              }\n            }\n\n            break;\n          }\n\n        case 3:\n          {\n            const scale = Math.max(Math.abs(s[p - 1]), Math.abs(s[p - 2]), Math.abs(e[p - 2]), Math.abs(s[k]), Math.abs(e[k]));\n            const sp = s[p - 1] / scale;\n            const spm1 = s[p - 2] / scale;\n            const epm1 = e[p - 2] / scale;\n            const sk = s[k] / scale;\n            const ek = e[k] / scale;\n            const b = ((spm1 + sp) * (spm1 - sp) + epm1 * epm1) / 2;\n            const c = sp * epm1 * (sp * epm1);\n            let shift = 0;\n\n            if (b !== 0 || c !== 0) {\n              if (b < 0) {\n                shift = 0 - Math.sqrt(b * b + c);\n              } else {\n                shift = Math.sqrt(b * b + c);\n              }\n\n              shift = c / (b + shift);\n            }\n\n            let f = (sk + sp) * (sk - sp) + shift;\n            let g = sk * ek;\n\n            for (let j = k; j < p - 1; j++) {\n              let t = hypotenuse(f, g);\n              if (t === 0) t = Number.MIN_VALUE;\n              let cs = f / t;\n              let sn = g / t;\n\n              if (j !== k) {\n                e[j - 1] = t;\n              }\n\n              f = cs * s[j] + sn * e[j];\n              e[j] = cs * e[j] - sn * s[j];\n              g = sn * s[j + 1];\n              s[j + 1] = cs * s[j + 1];\n\n              if (wantv) {\n                for (let i = 0; i < n; i++) {\n                  t = cs * V.get(i, j) + sn * V.get(i, j + 1);\n                  V.set(i, j + 1, -sn * V.get(i, j) + cs * V.get(i, j + 1));\n                  V.set(i, j, t);\n                }\n              }\n\n              t = hypotenuse(f, g);\n              if (t === 0) t = Number.MIN_VALUE;\n              cs = f / t;\n              sn = g / t;\n              s[j] = t;\n              f = cs * e[j] + sn * s[j + 1];\n              s[j + 1] = -sn * e[j] + cs * s[j + 1];\n              g = sn * e[j + 1];\n              e[j + 1] = cs * e[j + 1];\n\n              if (wantu && j < m - 1) {\n                for (let i = 0; i < m; i++) {\n                  t = cs * U.get(i, j) + sn * U.get(i, j + 1);\n                  U.set(i, j + 1, -sn * U.get(i, j) + cs * U.get(i, j + 1));\n                  U.set(i, j, t);\n                }\n              }\n            }\n\n            e[p - 2] = f;\n            iter = iter + 1;\n            break;\n          }\n\n        case 4:\n          {\n            if (s[k] <= 0) {\n              s[k] = s[k] < 0 ? -s[k] : 0;\n\n              if (wantv) {\n                for (let i = 0; i <= pp; i++) {\n                  V.set(i, k, -V.get(i, k));\n                }\n              }\n            }\n\n            while (k < pp) {\n              if (s[k] >= s[k + 1]) {\n                break;\n              }\n\n              let t = s[k];\n              s[k] = s[k + 1];\n              s[k + 1] = t;\n\n              if (wantv && k < n - 1) {\n                for (let i = 0; i < n; i++) {\n                  t = V.get(i, k + 1);\n                  V.set(i, k + 1, V.get(i, k));\n                  V.set(i, k, t);\n                }\n              }\n\n              if (wantu && k < m - 1) {\n                for (let i = 0; i < m; i++) {\n                  t = U.get(i, k + 1);\n                  U.set(i, k + 1, U.get(i, k));\n                  U.set(i, k, t);\n                }\n              }\n\n              k++;\n            }\n\n            iter = 0;\n            p--;\n            break;\n          }\n        // no default\n      }\n    }\n\n    if (swapped) {\n      let tmp = V;\n      V = U;\n      U = tmp;\n    }\n\n    this.m = m;\n    this.n = n;\n    this.s = s;\n    this.U = U;\n    this.V = V;\n  }\n\n  solve(value) {\n    let Y = value;\n    let e = this.threshold;\n    let scols = this.s.length;\n    let Ls = Matrix.zeros(scols, scols);\n\n    for (let i = 0; i < scols; i++) {\n      if (Math.abs(this.s[i]) <= e) {\n        Ls.set(i, i, 0);\n      } else {\n        Ls.set(i, i, 1 / this.s[i]);\n      }\n    }\n\n    let U = this.U;\n    let V = this.rightSingularVectors;\n    let VL = V.mmul(Ls);\n    let vrows = V.rows;\n    let urows = U.rows;\n    let VLU = Matrix.zeros(vrows, urows);\n\n    for (let i = 0; i < vrows; i++) {\n      for (let j = 0; j < urows; j++) {\n        let sum = 0;\n\n        for (let k = 0; k < scols; k++) {\n          sum += VL.get(i, k) * U.get(j, k);\n        }\n\n        VLU.set(i, j, sum);\n      }\n    }\n\n    return VLU.mmul(Y);\n  }\n\n  solveForDiagonal(value) {\n    return this.solve(Matrix.diag(value));\n  }\n\n  inverse() {\n    let V = this.V;\n    let e = this.threshold;\n    let vrows = V.rows;\n    let vcols = V.columns;\n    let X = new Matrix(vrows, this.s.length);\n\n    for (let i = 0; i < vrows; i++) {\n      for (let j = 0; j < vcols; j++) {\n        if (Math.abs(this.s[j]) > e) {\n          X.set(i, j, V.get(i, j) / this.s[j]);\n        }\n      }\n    }\n\n    let U = this.U;\n    let urows = U.rows;\n    let ucols = U.columns;\n    let Y = new Matrix(vrows, urows);\n\n    for (let i = 0; i < vrows; i++) {\n      for (let j = 0; j < urows; j++) {\n        let sum = 0;\n\n        for (let k = 0; k < ucols; k++) {\n          sum += X.get(i, k) * U.get(j, k);\n        }\n\n        Y.set(i, j, sum);\n      }\n    }\n\n    return Y;\n  }\n\n  get condition() {\n    return this.s[0] / this.s[Math.min(this.m, this.n) - 1];\n  }\n\n  get norm2() {\n    return this.s[0];\n  }\n\n  get rank() {\n    let tol = Math.max(this.m, this.n) * this.s[0] * Number.EPSILON;\n    let r = 0;\n    let s = this.s;\n\n    for (let i = 0, ii = s.length; i < ii; i++) {\n      if (s[i] > tol) {\n        r++;\n      }\n    }\n\n    return r;\n  }\n\n  get diagonal() {\n    return Array.from(this.s);\n  }\n\n  get threshold() {\n    return Number.EPSILON / 2 * Math.max(this.m, this.n) * this.s[0];\n  }\n\n  get leftSingularVectors() {\n    return this.U;\n  }\n\n  get rightSingularVectors() {\n    return this.V;\n  }\n\n  get diagonalMatrix() {\n    return Matrix.diag(this.s);\n  }\n\n}","map":{"version":3,"sources":["/Users/wanglijie/wanglijie/clover-defi-wallet/node_modules/ml-matrix/src/dc/svd.js"],"names":["Matrix","WrapperMatrix2D","hypotenuse","SingularValueDecomposition","constructor","value","options","checkMatrix","m","rows","n","columns","computeLeftSingularVectors","computeRightSingularVectors","autoTranspose","wantu","Boolean","wantv","swapped","a","clone","console","warn","transpose","aux","nu","Math","min","ni","s","Float64Array","U","V","e","work","si","i","nct","nrt","max","mrc","k","get","set","j","t","p","pp","iter","eps","Number","EPSILON","kase","alpha","MIN_VALUE","abs","isNaN","ks","f","cs","sn","scale","sp","spm1","epm1","sk","ek","b","c","shift","sqrt","g","tmp","solve","Y","threshold","scols","length","Ls","zeros","rightSingularVectors","VL","mmul","vrows","urows","VLU","sum","solveForDiagonal","diag","inverse","vcols","X","ucols","condition","norm2","rank","tol","r","ii","diagonal","Array","from","leftSingularVectors","diagonalMatrix"],"mappings":"AAAA,OAAOA,MAAP,MAAmB,WAAnB;AACA,OAAOC,eAAP,MAA4B,yBAA5B;AAEA,SAASC,UAAT,QAA2B,QAA3B;AAEA,eAAe,MAAMC,0BAAN,CAAiC;AAC9CC,EAAAA,WAAW,CAACC,KAAD,EAAQC,OAAO,GAAG,EAAlB,EAAsB;AAC/BD,IAAAA,KAAK,GAAGJ,eAAe,CAACM,WAAhB,CAA4BF,KAA5B,CAAR;AAEA,QAAIG,CAAC,GAAGH,KAAK,CAACI,IAAd;AACA,QAAIC,CAAC,GAAGL,KAAK,CAACM,OAAd;AAEA,UAAM;AACJC,MAAAA,0BAA0B,GAAG,IADzB;AAEJC,MAAAA,2BAA2B,GAAG,IAF1B;AAGJC,MAAAA,aAAa,GAAG;AAHZ,QAIFR,OAJJ;AAMA,QAAIS,KAAK,GAAGC,OAAO,CAACJ,0BAAD,CAAnB;AACA,QAAIK,KAAK,GAAGD,OAAO,CAACH,2BAAD,CAAnB;AAEA,QAAIK,OAAO,GAAG,KAAd;AACA,QAAIC,CAAJ;;AACA,QAAIX,CAAC,GAAGE,CAAR,EAAW;AACT,UAAI,CAACI,aAAL,EAAoB;AAClBK,QAAAA,CAAC,GAAGd,KAAK,CAACe,KAAN,EAAJ,CADkB,CAElB;;AACAC,QAAAA,OAAO,CAACC,IAAR,CACE,wFADF;AAGD,OAND,MAMO;AACLH,QAAAA,CAAC,GAAGd,KAAK,CAACkB,SAAN,EAAJ;AACAf,QAAAA,CAAC,GAAGW,CAAC,CAACV,IAAN;AACAC,QAAAA,CAAC,GAAGS,CAAC,CAACR,OAAN;AACAO,QAAAA,OAAO,GAAG,IAAV;AACA,YAAIM,GAAG,GAAGT,KAAV;AACAA,QAAAA,KAAK,GAAGE,KAAR;AACAA,QAAAA,KAAK,GAAGO,GAAR;AACD;AACF,KAhBD,MAgBO;AACLL,MAAAA,CAAC,GAAGd,KAAK,CAACe,KAAN,EAAJ;AACD;;AAED,QAAIK,EAAE,GAAGC,IAAI,CAACC,GAAL,CAASnB,CAAT,EAAYE,CAAZ,CAAT;AACA,QAAIkB,EAAE,GAAGF,IAAI,CAACC,GAAL,CAASnB,CAAC,GAAG,CAAb,EAAgBE,CAAhB,CAAT;AACA,QAAImB,CAAC,GAAG,IAAIC,YAAJ,CAAiBF,EAAjB,CAAR;AACA,QAAIG,CAAC,GAAG,IAAI/B,MAAJ,CAAWQ,CAAX,EAAciB,EAAd,CAAR;AACA,QAAIO,CAAC,GAAG,IAAIhC,MAAJ,CAAWU,CAAX,EAAcA,CAAd,CAAR;AAEA,QAAIuB,CAAC,GAAG,IAAIH,YAAJ,CAAiBpB,CAAjB,CAAR;AACA,QAAIwB,IAAI,GAAG,IAAIJ,YAAJ,CAAiBtB,CAAjB,CAAX;AAEA,QAAI2B,EAAE,GAAG,IAAIL,YAAJ,CAAiBF,EAAjB,CAAT;;AACA,SAAK,IAAIQ,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGR,EAApB,EAAwBQ,CAAC,EAAzB,EAA6BD,EAAE,CAACC,CAAD,CAAF,GAAQA,CAAR;;AAE7B,QAAIC,GAAG,GAAGX,IAAI,CAACC,GAAL,CAASnB,CAAC,GAAG,CAAb,EAAgBE,CAAhB,CAAV;AACA,QAAI4B,GAAG,GAAGZ,IAAI,CAACa,GAAL,CAAS,CAAT,EAAYb,IAAI,CAACC,GAAL,CAASjB,CAAC,GAAG,CAAb,EAAgBF,CAAhB,CAAZ,CAAV;AACA,QAAIgC,GAAG,GAAGd,IAAI,CAACa,GAAL,CAASF,GAAT,EAAcC,GAAd,CAAV;;AAEA,SAAK,IAAIG,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGD,GAApB,EAAyBC,CAAC,EAA1B,EAA8B;AAC5B,UAAIA,CAAC,GAAGJ,GAAR,EAAa;AACXR,QAAAA,CAAC,CAACY,CAAD,CAAD,GAAO,CAAP;;AACA,aAAK,IAAIL,CAAC,GAAGK,CAAb,EAAgBL,CAAC,GAAG5B,CAApB,EAAuB4B,CAAC,EAAxB,EAA4B;AAC1BP,UAAAA,CAAC,CAACY,CAAD,CAAD,GAAOvC,UAAU,CAAC2B,CAAC,CAACY,CAAD,CAAF,EAAOtB,CAAC,CAACuB,GAAF,CAAMN,CAAN,EAASK,CAAT,CAAP,CAAjB;AACD;;AACD,YAAIZ,CAAC,CAACY,CAAD,CAAD,KAAS,CAAb,EAAgB;AACd,cAAItB,CAAC,CAACuB,GAAF,CAAMD,CAAN,EAASA,CAAT,IAAc,CAAlB,EAAqB;AACnBZ,YAAAA,CAAC,CAACY,CAAD,CAAD,GAAO,CAACZ,CAAC,CAACY,CAAD,CAAT;AACD;;AACD,eAAK,IAAIL,CAAC,GAAGK,CAAb,EAAgBL,CAAC,GAAG5B,CAApB,EAAuB4B,CAAC,EAAxB,EAA4B;AAC1BjB,YAAAA,CAAC,CAACwB,GAAF,CAAMP,CAAN,EAASK,CAAT,EAAYtB,CAAC,CAACuB,GAAF,CAAMN,CAAN,EAASK,CAAT,IAAcZ,CAAC,CAACY,CAAD,CAA3B;AACD;;AACDtB,UAAAA,CAAC,CAACwB,GAAF,CAAMF,CAAN,EAASA,CAAT,EAAYtB,CAAC,CAACuB,GAAF,CAAMD,CAAN,EAASA,CAAT,IAAc,CAA1B;AACD;;AACDZ,QAAAA,CAAC,CAACY,CAAD,CAAD,GAAO,CAACZ,CAAC,CAACY,CAAD,CAAT;AACD;;AAED,WAAK,IAAIG,CAAC,GAAGH,CAAC,GAAG,CAAjB,EAAoBG,CAAC,GAAGlC,CAAxB,EAA2BkC,CAAC,EAA5B,EAAgC;AAC9B,YAAIH,CAAC,GAAGJ,GAAJ,IAAWR,CAAC,CAACY,CAAD,CAAD,KAAS,CAAxB,EAA2B;AACzB,cAAII,CAAC,GAAG,CAAR;;AACA,eAAK,IAAIT,CAAC,GAAGK,CAAb,EAAgBL,CAAC,GAAG5B,CAApB,EAAuB4B,CAAC,EAAxB,EAA4B;AAC1BS,YAAAA,CAAC,IAAI1B,CAAC,CAACuB,GAAF,CAAMN,CAAN,EAASK,CAAT,IAActB,CAAC,CAACuB,GAAF,CAAMN,CAAN,EAASQ,CAAT,CAAnB;AACD;;AACDC,UAAAA,CAAC,GAAG,CAACA,CAAD,GAAK1B,CAAC,CAACuB,GAAF,CAAMD,CAAN,EAASA,CAAT,CAAT;;AACA,eAAK,IAAIL,CAAC,GAAGK,CAAb,EAAgBL,CAAC,GAAG5B,CAApB,EAAuB4B,CAAC,EAAxB,EAA4B;AAC1BjB,YAAAA,CAAC,CAACwB,GAAF,CAAMP,CAAN,EAASQ,CAAT,EAAYzB,CAAC,CAACuB,GAAF,CAAMN,CAAN,EAASQ,CAAT,IAAcC,CAAC,GAAG1B,CAAC,CAACuB,GAAF,CAAMN,CAAN,EAASK,CAAT,CAA9B;AACD;AACF;;AACDR,QAAAA,CAAC,CAACW,CAAD,CAAD,GAAOzB,CAAC,CAACuB,GAAF,CAAMD,CAAN,EAASG,CAAT,CAAP;AACD;;AAED,UAAI7B,KAAK,IAAI0B,CAAC,GAAGJ,GAAjB,EAAsB;AACpB,aAAK,IAAID,CAAC,GAAGK,CAAb,EAAgBL,CAAC,GAAG5B,CAApB,EAAuB4B,CAAC,EAAxB,EAA4B;AAC1BL,UAAAA,CAAC,CAACY,GAAF,CAAMP,CAAN,EAASK,CAAT,EAAYtB,CAAC,CAACuB,GAAF,CAAMN,CAAN,EAASK,CAAT,CAAZ;AACD;AACF;;AAED,UAAIA,CAAC,GAAGH,GAAR,EAAa;AACXL,QAAAA,CAAC,CAACQ,CAAD,CAAD,GAAO,CAAP;;AACA,aAAK,IAAIL,CAAC,GAAGK,CAAC,GAAG,CAAjB,EAAoBL,CAAC,GAAG1B,CAAxB,EAA2B0B,CAAC,EAA5B,EAAgC;AAC9BH,UAAAA,CAAC,CAACQ,CAAD,CAAD,GAAOvC,UAAU,CAAC+B,CAAC,CAACQ,CAAD,CAAF,EAAOR,CAAC,CAACG,CAAD,CAAR,CAAjB;AACD;;AACD,YAAIH,CAAC,CAACQ,CAAD,CAAD,KAAS,CAAb,EAAgB;AACd,cAAIR,CAAC,CAACQ,CAAC,GAAG,CAAL,CAAD,GAAW,CAAf,EAAkB;AAChBR,YAAAA,CAAC,CAACQ,CAAD,CAAD,GAAO,IAAIR,CAAC,CAACQ,CAAD,CAAZ;AACD;;AACD,eAAK,IAAIL,CAAC,GAAGK,CAAC,GAAG,CAAjB,EAAoBL,CAAC,GAAG1B,CAAxB,EAA2B0B,CAAC,EAA5B,EAAgC;AAC9BH,YAAAA,CAAC,CAACG,CAAD,CAAD,IAAQH,CAAC,CAACQ,CAAD,CAAT;AACD;;AACDR,UAAAA,CAAC,CAACQ,CAAC,GAAG,CAAL,CAAD,IAAY,CAAZ;AACD;;AACDR,QAAAA,CAAC,CAACQ,CAAD,CAAD,GAAO,CAACR,CAAC,CAACQ,CAAD,CAAT;;AACA,YAAIA,CAAC,GAAG,CAAJ,GAAQjC,CAAR,IAAayB,CAAC,CAACQ,CAAD,CAAD,KAAS,CAA1B,EAA6B;AAC3B,eAAK,IAAIL,CAAC,GAAGK,CAAC,GAAG,CAAjB,EAAoBL,CAAC,GAAG5B,CAAxB,EAA2B4B,CAAC,EAA5B,EAAgC;AAC9BF,YAAAA,IAAI,CAACE,CAAD,CAAJ,GAAU,CAAV;AACD;;AACD,eAAK,IAAIA,CAAC,GAAGK,CAAC,GAAG,CAAjB,EAAoBL,CAAC,GAAG5B,CAAxB,EAA2B4B,CAAC,EAA5B,EAAgC;AAC9B,iBAAK,IAAIQ,CAAC,GAAGH,CAAC,GAAG,CAAjB,EAAoBG,CAAC,GAAGlC,CAAxB,EAA2BkC,CAAC,EAA5B,EAAgC;AAC9BV,cAAAA,IAAI,CAACE,CAAD,CAAJ,IAAWH,CAAC,CAACW,CAAD,CAAD,GAAOzB,CAAC,CAACuB,GAAF,CAAMN,CAAN,EAASQ,CAAT,CAAlB;AACD;AACF;;AACD,eAAK,IAAIA,CAAC,GAAGH,CAAC,GAAG,CAAjB,EAAoBG,CAAC,GAAGlC,CAAxB,EAA2BkC,CAAC,EAA5B,EAAgC;AAC9B,gBAAIC,CAAC,GAAG,CAACZ,CAAC,CAACW,CAAD,CAAF,GAAQX,CAAC,CAACQ,CAAC,GAAG,CAAL,CAAjB;;AACA,iBAAK,IAAIL,CAAC,GAAGK,CAAC,GAAG,CAAjB,EAAoBL,CAAC,GAAG5B,CAAxB,EAA2B4B,CAAC,EAA5B,EAAgC;AAC9BjB,cAAAA,CAAC,CAACwB,GAAF,CAAMP,CAAN,EAASQ,CAAT,EAAYzB,CAAC,CAACuB,GAAF,CAAMN,CAAN,EAASQ,CAAT,IAAcC,CAAC,GAAGX,IAAI,CAACE,CAAD,CAAlC;AACD;AACF;AACF;;AACD,YAAInB,KAAJ,EAAW;AACT,eAAK,IAAImB,CAAC,GAAGK,CAAC,GAAG,CAAjB,EAAoBL,CAAC,GAAG1B,CAAxB,EAA2B0B,CAAC,EAA5B,EAAgC;AAC9BJ,YAAAA,CAAC,CAACW,GAAF,CAAMP,CAAN,EAASK,CAAT,EAAYR,CAAC,CAACG,CAAD,CAAb;AACD;AACF;AACF;AACF;;AAED,QAAIU,CAAC,GAAGpB,IAAI,CAACC,GAAL,CAASjB,CAAT,EAAYF,CAAC,GAAG,CAAhB,CAAR;;AACA,QAAI6B,GAAG,GAAG3B,CAAV,EAAa;AACXmB,MAAAA,CAAC,CAACQ,GAAD,CAAD,GAASlB,CAAC,CAACuB,GAAF,CAAML,GAAN,EAAWA,GAAX,CAAT;AACD;;AACD,QAAI7B,CAAC,GAAGsC,CAAR,EAAW;AACTjB,MAAAA,CAAC,CAACiB,CAAC,GAAG,CAAL,CAAD,GAAW,CAAX;AACD;;AACD,QAAIR,GAAG,GAAG,CAAN,GAAUQ,CAAd,EAAiB;AACfb,MAAAA,CAAC,CAACK,GAAD,CAAD,GAASnB,CAAC,CAACuB,GAAF,CAAMJ,GAAN,EAAWQ,CAAC,GAAG,CAAf,CAAT;AACD;;AACDb,IAAAA,CAAC,CAACa,CAAC,GAAG,CAAL,CAAD,GAAW,CAAX;;AAEA,QAAI/B,KAAJ,EAAW;AACT,WAAK,IAAI6B,CAAC,GAAGP,GAAb,EAAkBO,CAAC,GAAGnB,EAAtB,EAA0BmB,CAAC,EAA3B,EAA+B;AAC7B,aAAK,IAAIR,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG5B,CAApB,EAAuB4B,CAAC,EAAxB,EAA4B;AAC1BL,UAAAA,CAAC,CAACY,GAAF,CAAMP,CAAN,EAASQ,CAAT,EAAY,CAAZ;AACD;;AACDb,QAAAA,CAAC,CAACY,GAAF,CAAMC,CAAN,EAASA,CAAT,EAAY,CAAZ;AACD;;AACD,WAAK,IAAIH,CAAC,GAAGJ,GAAG,GAAG,CAAnB,EAAsBI,CAAC,IAAI,CAA3B,EAA8BA,CAAC,EAA/B,EAAmC;AACjC,YAAIZ,CAAC,CAACY,CAAD,CAAD,KAAS,CAAb,EAAgB;AACd,eAAK,IAAIG,CAAC,GAAGH,CAAC,GAAG,CAAjB,EAAoBG,CAAC,GAAGnB,EAAxB,EAA4BmB,CAAC,EAA7B,EAAiC;AAC/B,gBAAIC,CAAC,GAAG,CAAR;;AACA,iBAAK,IAAIT,CAAC,GAAGK,CAAb,EAAgBL,CAAC,GAAG5B,CAApB,EAAuB4B,CAAC,EAAxB,EAA4B;AAC1BS,cAAAA,CAAC,IAAId,CAAC,CAACW,GAAF,CAAMN,CAAN,EAASK,CAAT,IAAcV,CAAC,CAACW,GAAF,CAAMN,CAAN,EAASQ,CAAT,CAAnB;AACD;;AACDC,YAAAA,CAAC,GAAG,CAACA,CAAD,GAAKd,CAAC,CAACW,GAAF,CAAMD,CAAN,EAASA,CAAT,CAAT;;AACA,iBAAK,IAAIL,CAAC,GAAGK,CAAb,EAAgBL,CAAC,GAAG5B,CAApB,EAAuB4B,CAAC,EAAxB,EAA4B;AAC1BL,cAAAA,CAAC,CAACY,GAAF,CAAMP,CAAN,EAASQ,CAAT,EAAYb,CAAC,CAACW,GAAF,CAAMN,CAAN,EAASQ,CAAT,IAAcC,CAAC,GAAGd,CAAC,CAACW,GAAF,CAAMN,CAAN,EAASK,CAAT,CAA9B;AACD;AACF;;AACD,eAAK,IAAIL,CAAC,GAAGK,CAAb,EAAgBL,CAAC,GAAG5B,CAApB,EAAuB4B,CAAC,EAAxB,EAA4B;AAC1BL,YAAAA,CAAC,CAACY,GAAF,CAAMP,CAAN,EAASK,CAAT,EAAY,CAACV,CAAC,CAACW,GAAF,CAAMN,CAAN,EAASK,CAAT,CAAb;AACD;;AACDV,UAAAA,CAAC,CAACY,GAAF,CAAMF,CAAN,EAASA,CAAT,EAAY,IAAIV,CAAC,CAACW,GAAF,CAAMD,CAAN,EAASA,CAAT,CAAhB;;AACA,eAAK,IAAIL,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGK,CAAC,GAAG,CAAxB,EAA2BL,CAAC,EAA5B,EAAgC;AAC9BL,YAAAA,CAAC,CAACY,GAAF,CAAMP,CAAN,EAASK,CAAT,EAAY,CAAZ;AACD;AACF,SAlBD,MAkBO;AACL,eAAK,IAAIL,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG5B,CAApB,EAAuB4B,CAAC,EAAxB,EAA4B;AAC1BL,YAAAA,CAAC,CAACY,GAAF,CAAMP,CAAN,EAASK,CAAT,EAAY,CAAZ;AACD;;AACDV,UAAAA,CAAC,CAACY,GAAF,CAAMF,CAAN,EAASA,CAAT,EAAY,CAAZ;AACD;AACF;AACF;;AAED,QAAIxB,KAAJ,EAAW;AACT,WAAK,IAAIwB,CAAC,GAAG/B,CAAC,GAAG,CAAjB,EAAoB+B,CAAC,IAAI,CAAzB,EAA4BA,CAAC,EAA7B,EAAiC;AAC/B,YAAIA,CAAC,GAAGH,GAAJ,IAAWL,CAAC,CAACQ,CAAD,CAAD,KAAS,CAAxB,EAA2B;AACzB,eAAK,IAAIG,CAAC,GAAGH,CAAC,GAAG,CAAjB,EAAoBG,CAAC,GAAGlC,CAAxB,EAA2BkC,CAAC,EAA5B,EAAgC;AAC9B,gBAAIC,CAAC,GAAG,CAAR;;AACA,iBAAK,IAAIT,CAAC,GAAGK,CAAC,GAAG,CAAjB,EAAoBL,CAAC,GAAG1B,CAAxB,EAA2B0B,CAAC,EAA5B,EAAgC;AAC9BS,cAAAA,CAAC,IAAIb,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASK,CAAT,IAAcT,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASQ,CAAT,CAAnB;AACD;;AACDC,YAAAA,CAAC,GAAG,CAACA,CAAD,GAAKb,CAAC,CAACU,GAAF,CAAMD,CAAC,GAAG,CAAV,EAAaA,CAAb,CAAT;;AACA,iBAAK,IAAIL,CAAC,GAAGK,CAAC,GAAG,CAAjB,EAAoBL,CAAC,GAAG1B,CAAxB,EAA2B0B,CAAC,EAA5B,EAAgC;AAC9BJ,cAAAA,CAAC,CAACW,GAAF,CAAMP,CAAN,EAASQ,CAAT,EAAYZ,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASQ,CAAT,IAAcC,CAAC,GAAGb,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASK,CAAT,CAA9B;AACD;AACF;AACF;;AACD,aAAK,IAAIL,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG1B,CAApB,EAAuB0B,CAAC,EAAxB,EAA4B;AAC1BJ,UAAAA,CAAC,CAACW,GAAF,CAAMP,CAAN,EAASK,CAAT,EAAY,CAAZ;AACD;;AACDT,QAAAA,CAAC,CAACW,GAAF,CAAMF,CAAN,EAASA,CAAT,EAAY,CAAZ;AACD;AACF;;AAED,QAAIM,EAAE,GAAGD,CAAC,GAAG,CAAb;AACA,QAAIE,IAAI,GAAG,CAAX;AACA,QAAIC,GAAG,GAAGC,MAAM,CAACC,OAAjB;;AACA,WAAOL,CAAC,GAAG,CAAX,EAAc;AACZ,UAAIL,CAAJ,EAAOW,IAAP;;AACA,WAAKX,CAAC,GAAGK,CAAC,GAAG,CAAb,EAAgBL,CAAC,IAAI,CAAC,CAAtB,EAAyBA,CAAC,EAA1B,EAA8B;AAC5B,YAAIA,CAAC,KAAK,CAAC,CAAX,EAAc;AACZ;AACD;;AACD,cAAMY,KAAK,GACTH,MAAM,CAACI,SAAP,GAAmBL,GAAG,GAAGvB,IAAI,CAAC6B,GAAL,CAAS1B,CAAC,CAACY,CAAD,CAAD,GAAOf,IAAI,CAAC6B,GAAL,CAAS1B,CAAC,CAACY,CAAC,GAAG,CAAL,CAAV,CAAhB,CAD3B;;AAEA,YAAIf,IAAI,CAAC6B,GAAL,CAAStB,CAAC,CAACQ,CAAD,CAAV,KAAkBY,KAAlB,IAA2BH,MAAM,CAACM,KAAP,CAAavB,CAAC,CAACQ,CAAD,CAAd,CAA/B,EAAmD;AACjDR,UAAAA,CAAC,CAACQ,CAAD,CAAD,GAAO,CAAP;AACA;AACD;AACF;;AACD,UAAIA,CAAC,KAAKK,CAAC,GAAG,CAAd,EAAiB;AACfM,QAAAA,IAAI,GAAG,CAAP;AACD,OAFD,MAEO;AACL,YAAIK,EAAJ;;AACA,aAAKA,EAAE,GAAGX,CAAC,GAAG,CAAd,EAAiBW,EAAE,IAAIhB,CAAvB,EAA0BgB,EAAE,EAA5B,EAAgC;AAC9B,cAAIA,EAAE,KAAKhB,CAAX,EAAc;AACZ;AACD;;AACD,cAAII,CAAC,GACH,CAACY,EAAE,KAAKX,CAAP,GAAWpB,IAAI,CAAC6B,GAAL,CAAStB,CAAC,CAACwB,EAAD,CAAV,CAAX,GAA6B,CAA9B,KACCA,EAAE,KAAKhB,CAAC,GAAG,CAAX,GAAef,IAAI,CAAC6B,GAAL,CAAStB,CAAC,CAACwB,EAAE,GAAG,CAAN,CAAV,CAAf,GAAqC,CADtC,CADF;;AAGA,cAAI/B,IAAI,CAAC6B,GAAL,CAAS1B,CAAC,CAAC4B,EAAD,CAAV,KAAmBR,GAAG,GAAGJ,CAA7B,EAAgC;AAC9BhB,YAAAA,CAAC,CAAC4B,EAAD,CAAD,GAAQ,CAAR;AACA;AACD;AACF;;AACD,YAAIA,EAAE,KAAKhB,CAAX,EAAc;AACZW,UAAAA,IAAI,GAAG,CAAP;AACD,SAFD,MAEO,IAAIK,EAAE,KAAKX,CAAC,GAAG,CAAf,EAAkB;AACvBM,UAAAA,IAAI,GAAG,CAAP;AACD,SAFM,MAEA;AACLA,UAAAA,IAAI,GAAG,CAAP;AACAX,UAAAA,CAAC,GAAGgB,EAAJ;AACD;AACF;;AAEDhB,MAAAA,CAAC;;AAED,cAAQW,IAAR;AACE,aAAK,CAAL;AAAQ;AACN,gBAAIM,CAAC,GAAGzB,CAAC,CAACa,CAAC,GAAG,CAAL,CAAT;AACAb,YAAAA,CAAC,CAACa,CAAC,GAAG,CAAL,CAAD,GAAW,CAAX;;AACA,iBAAK,IAAIF,CAAC,GAAGE,CAAC,GAAG,CAAjB,EAAoBF,CAAC,IAAIH,CAAzB,EAA4BG,CAAC,EAA7B,EAAiC;AAC/B,kBAAIC,CAAC,GAAG3C,UAAU,CAAC2B,CAAC,CAACe,CAAD,CAAF,EAAOc,CAAP,CAAlB;AACA,kBAAIC,EAAE,GAAG9B,CAAC,CAACe,CAAD,CAAD,GAAOC,CAAhB;AACA,kBAAIe,EAAE,GAAGF,CAAC,GAAGb,CAAb;AACAhB,cAAAA,CAAC,CAACe,CAAD,CAAD,GAAOC,CAAP;;AACA,kBAAID,CAAC,KAAKH,CAAV,EAAa;AACXiB,gBAAAA,CAAC,GAAG,CAACE,EAAD,GAAM3B,CAAC,CAACW,CAAC,GAAG,CAAL,CAAX;AACAX,gBAAAA,CAAC,CAACW,CAAC,GAAG,CAAL,CAAD,GAAWe,EAAE,GAAG1B,CAAC,CAACW,CAAC,GAAG,CAAL,CAAjB;AACD;;AACD,kBAAI3B,KAAJ,EAAW;AACT,qBAAK,IAAImB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG1B,CAApB,EAAuB0B,CAAC,EAAxB,EAA4B;AAC1BS,kBAAAA,CAAC,GAAGc,EAAE,GAAG3B,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASQ,CAAT,CAAL,GAAmBgB,EAAE,GAAG5B,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASU,CAAC,GAAG,CAAb,CAA5B;AACAd,kBAAAA,CAAC,CAACW,GAAF,CAAMP,CAAN,EAASU,CAAC,GAAG,CAAb,EAAgB,CAACc,EAAD,GAAM5B,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASQ,CAAT,CAAN,GAAoBe,EAAE,GAAG3B,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASU,CAAC,GAAG,CAAb,CAAzC;AACAd,kBAAAA,CAAC,CAACW,GAAF,CAAMP,CAAN,EAASQ,CAAT,EAAYC,CAAZ;AACD;AACF;AACF;;AACD;AACD;;AACD,aAAK,CAAL;AAAQ;AACN,gBAAIa,CAAC,GAAGzB,CAAC,CAACQ,CAAC,GAAG,CAAL,CAAT;AACAR,YAAAA,CAAC,CAACQ,CAAC,GAAG,CAAL,CAAD,GAAW,CAAX;;AACA,iBAAK,IAAIG,CAAC,GAAGH,CAAb,EAAgBG,CAAC,GAAGE,CAApB,EAAuBF,CAAC,EAAxB,EAA4B;AAC1B,kBAAIC,CAAC,GAAG3C,UAAU,CAAC2B,CAAC,CAACe,CAAD,CAAF,EAAOc,CAAP,CAAlB;AACA,kBAAIC,EAAE,GAAG9B,CAAC,CAACe,CAAD,CAAD,GAAOC,CAAhB;AACA,kBAAIe,EAAE,GAAGF,CAAC,GAAGb,CAAb;AACAhB,cAAAA,CAAC,CAACe,CAAD,CAAD,GAAOC,CAAP;AACAa,cAAAA,CAAC,GAAG,CAACE,EAAD,GAAM3B,CAAC,CAACW,CAAD,CAAX;AACAX,cAAAA,CAAC,CAACW,CAAD,CAAD,GAAOe,EAAE,GAAG1B,CAAC,CAACW,CAAD,CAAb;;AACA,kBAAI7B,KAAJ,EAAW;AACT,qBAAK,IAAIqB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG5B,CAApB,EAAuB4B,CAAC,EAAxB,EAA4B;AAC1BS,kBAAAA,CAAC,GAAGc,EAAE,GAAG5B,CAAC,CAACW,GAAF,CAAMN,CAAN,EAASQ,CAAT,CAAL,GAAmBgB,EAAE,GAAG7B,CAAC,CAACW,GAAF,CAAMN,CAAN,EAASK,CAAC,GAAG,CAAb,CAA5B;AACAV,kBAAAA,CAAC,CAACY,GAAF,CAAMP,CAAN,EAASK,CAAC,GAAG,CAAb,EAAgB,CAACmB,EAAD,GAAM7B,CAAC,CAACW,GAAF,CAAMN,CAAN,EAASQ,CAAT,CAAN,GAAoBe,EAAE,GAAG5B,CAAC,CAACW,GAAF,CAAMN,CAAN,EAASK,CAAC,GAAG,CAAb,CAAzC;AACAV,kBAAAA,CAAC,CAACY,GAAF,CAAMP,CAAN,EAASQ,CAAT,EAAYC,CAAZ;AACD;AACF;AACF;;AACD;AACD;;AACD,aAAK,CAAL;AAAQ;AACN,kBAAMgB,KAAK,GAAGnC,IAAI,CAACa,GAAL,CACZb,IAAI,CAAC6B,GAAL,CAAS1B,CAAC,CAACiB,CAAC,GAAG,CAAL,CAAV,CADY,EAEZpB,IAAI,CAAC6B,GAAL,CAAS1B,CAAC,CAACiB,CAAC,GAAG,CAAL,CAAV,CAFY,EAGZpB,IAAI,CAAC6B,GAAL,CAAStB,CAAC,CAACa,CAAC,GAAG,CAAL,CAAV,CAHY,EAIZpB,IAAI,CAAC6B,GAAL,CAAS1B,CAAC,CAACY,CAAD,CAAV,CAJY,EAKZf,IAAI,CAAC6B,GAAL,CAAStB,CAAC,CAACQ,CAAD,CAAV,CALY,CAAd;AAOA,kBAAMqB,EAAE,GAAGjC,CAAC,CAACiB,CAAC,GAAG,CAAL,CAAD,GAAWe,KAAtB;AACA,kBAAME,IAAI,GAAGlC,CAAC,CAACiB,CAAC,GAAG,CAAL,CAAD,GAAWe,KAAxB;AACA,kBAAMG,IAAI,GAAG/B,CAAC,CAACa,CAAC,GAAG,CAAL,CAAD,GAAWe,KAAxB;AACA,kBAAMI,EAAE,GAAGpC,CAAC,CAACY,CAAD,CAAD,GAAOoB,KAAlB;AACA,kBAAMK,EAAE,GAAGjC,CAAC,CAACQ,CAAD,CAAD,GAAOoB,KAAlB;AACA,kBAAMM,CAAC,GAAG,CAAC,CAACJ,IAAI,GAAGD,EAAR,KAAeC,IAAI,GAAGD,EAAtB,IAA4BE,IAAI,GAAGA,IAApC,IAA4C,CAAtD;AACA,kBAAMI,CAAC,GAAGN,EAAE,GAAGE,IAAL,IAAaF,EAAE,GAAGE,IAAlB,CAAV;AACA,gBAAIK,KAAK,GAAG,CAAZ;;AACA,gBAAIF,CAAC,KAAK,CAAN,IAAWC,CAAC,KAAK,CAArB,EAAwB;AACtB,kBAAID,CAAC,GAAG,CAAR,EAAW;AACTE,gBAAAA,KAAK,GAAG,IAAI3C,IAAI,CAAC4C,IAAL,CAAUH,CAAC,GAAGA,CAAJ,GAAQC,CAAlB,CAAZ;AACD,eAFD,MAEO;AACLC,gBAAAA,KAAK,GAAG3C,IAAI,CAAC4C,IAAL,CAAUH,CAAC,GAAGA,CAAJ,GAAQC,CAAlB,CAAR;AACD;;AACDC,cAAAA,KAAK,GAAGD,CAAC,IAAID,CAAC,GAAGE,KAAR,CAAT;AACD;;AACD,gBAAIX,CAAC,GAAG,CAACO,EAAE,GAAGH,EAAN,KAAaG,EAAE,GAAGH,EAAlB,IAAwBO,KAAhC;AACA,gBAAIE,CAAC,GAAGN,EAAE,GAAGC,EAAb;;AACA,iBAAK,IAAItB,CAAC,GAAGH,CAAb,EAAgBG,CAAC,GAAGE,CAAC,GAAG,CAAxB,EAA2BF,CAAC,EAA5B,EAAgC;AAC9B,kBAAIC,CAAC,GAAG3C,UAAU,CAACwD,CAAD,EAAIa,CAAJ,CAAlB;AACA,kBAAI1B,CAAC,KAAK,CAAV,EAAaA,CAAC,GAAGK,MAAM,CAACI,SAAX;AACb,kBAAIK,EAAE,GAAGD,CAAC,GAAGb,CAAb;AACA,kBAAIe,EAAE,GAAGW,CAAC,GAAG1B,CAAb;;AACA,kBAAID,CAAC,KAAKH,CAAV,EAAa;AACXR,gBAAAA,CAAC,CAACW,CAAC,GAAG,CAAL,CAAD,GAAWC,CAAX;AACD;;AACDa,cAAAA,CAAC,GAAGC,EAAE,GAAG9B,CAAC,CAACe,CAAD,CAAN,GAAYgB,EAAE,GAAG3B,CAAC,CAACW,CAAD,CAAtB;AACAX,cAAAA,CAAC,CAACW,CAAD,CAAD,GAAOe,EAAE,GAAG1B,CAAC,CAACW,CAAD,CAAN,GAAYgB,EAAE,GAAG/B,CAAC,CAACe,CAAD,CAAzB;AACA2B,cAAAA,CAAC,GAAGX,EAAE,GAAG/B,CAAC,CAACe,CAAC,GAAG,CAAL,CAAV;AACAf,cAAAA,CAAC,CAACe,CAAC,GAAG,CAAL,CAAD,GAAWe,EAAE,GAAG9B,CAAC,CAACe,CAAC,GAAG,CAAL,CAAjB;;AACA,kBAAI3B,KAAJ,EAAW;AACT,qBAAK,IAAImB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG1B,CAApB,EAAuB0B,CAAC,EAAxB,EAA4B;AAC1BS,kBAAAA,CAAC,GAAGc,EAAE,GAAG3B,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASQ,CAAT,CAAL,GAAmBgB,EAAE,GAAG5B,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASQ,CAAC,GAAG,CAAb,CAA5B;AACAZ,kBAAAA,CAAC,CAACW,GAAF,CAAMP,CAAN,EAASQ,CAAC,GAAG,CAAb,EAAgB,CAACgB,EAAD,GAAM5B,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASQ,CAAT,CAAN,GAAoBe,EAAE,GAAG3B,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASQ,CAAC,GAAG,CAAb,CAAzC;AACAZ,kBAAAA,CAAC,CAACW,GAAF,CAAMP,CAAN,EAASQ,CAAT,EAAYC,CAAZ;AACD;AACF;;AACDA,cAAAA,CAAC,GAAG3C,UAAU,CAACwD,CAAD,EAAIa,CAAJ,CAAd;AACA,kBAAI1B,CAAC,KAAK,CAAV,EAAaA,CAAC,GAAGK,MAAM,CAACI,SAAX;AACbK,cAAAA,EAAE,GAAGD,CAAC,GAAGb,CAAT;AACAe,cAAAA,EAAE,GAAGW,CAAC,GAAG1B,CAAT;AACAhB,cAAAA,CAAC,CAACe,CAAD,CAAD,GAAOC,CAAP;AACAa,cAAAA,CAAC,GAAGC,EAAE,GAAG1B,CAAC,CAACW,CAAD,CAAN,GAAYgB,EAAE,GAAG/B,CAAC,CAACe,CAAC,GAAG,CAAL,CAAtB;AACAf,cAAAA,CAAC,CAACe,CAAC,GAAG,CAAL,CAAD,GAAW,CAACgB,EAAD,GAAM3B,CAAC,CAACW,CAAD,CAAP,GAAae,EAAE,GAAG9B,CAAC,CAACe,CAAC,GAAG,CAAL,CAA9B;AACA2B,cAAAA,CAAC,GAAGX,EAAE,GAAG3B,CAAC,CAACW,CAAC,GAAG,CAAL,CAAV;AACAX,cAAAA,CAAC,CAACW,CAAC,GAAG,CAAL,CAAD,GAAWe,EAAE,GAAG1B,CAAC,CAACW,CAAC,GAAG,CAAL,CAAjB;;AACA,kBAAI7B,KAAK,IAAI6B,CAAC,GAAGpC,CAAC,GAAG,CAArB,EAAwB;AACtB,qBAAK,IAAI4B,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG5B,CAApB,EAAuB4B,CAAC,EAAxB,EAA4B;AAC1BS,kBAAAA,CAAC,GAAGc,EAAE,GAAG5B,CAAC,CAACW,GAAF,CAAMN,CAAN,EAASQ,CAAT,CAAL,GAAmBgB,EAAE,GAAG7B,CAAC,CAACW,GAAF,CAAMN,CAAN,EAASQ,CAAC,GAAG,CAAb,CAA5B;AACAb,kBAAAA,CAAC,CAACY,GAAF,CAAMP,CAAN,EAASQ,CAAC,GAAG,CAAb,EAAgB,CAACgB,EAAD,GAAM7B,CAAC,CAACW,GAAF,CAAMN,CAAN,EAASQ,CAAT,CAAN,GAAoBe,EAAE,GAAG5B,CAAC,CAACW,GAAF,CAAMN,CAAN,EAASQ,CAAC,GAAG,CAAb,CAAzC;AACAb,kBAAAA,CAAC,CAACY,GAAF,CAAMP,CAAN,EAASQ,CAAT,EAAYC,CAAZ;AACD;AACF;AACF;;AACDZ,YAAAA,CAAC,CAACa,CAAC,GAAG,CAAL,CAAD,GAAWY,CAAX;AACAV,YAAAA,IAAI,GAAGA,IAAI,GAAG,CAAd;AACA;AACD;;AACD,aAAK,CAAL;AAAQ;AACN,gBAAInB,CAAC,CAACY,CAAD,CAAD,IAAQ,CAAZ,EAAe;AACbZ,cAAAA,CAAC,CAACY,CAAD,CAAD,GAAOZ,CAAC,CAACY,CAAD,CAAD,GAAO,CAAP,GAAW,CAACZ,CAAC,CAACY,CAAD,CAAb,GAAmB,CAA1B;;AACA,kBAAIxB,KAAJ,EAAW;AACT,qBAAK,IAAImB,CAAC,GAAG,CAAb,EAAgBA,CAAC,IAAIW,EAArB,EAAyBX,CAAC,EAA1B,EAA8B;AAC5BJ,kBAAAA,CAAC,CAACW,GAAF,CAAMP,CAAN,EAASK,CAAT,EAAY,CAACT,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASK,CAAT,CAAb;AACD;AACF;AACF;;AACD,mBAAOA,CAAC,GAAGM,EAAX,EAAe;AACb,kBAAIlB,CAAC,CAACY,CAAD,CAAD,IAAQZ,CAAC,CAACY,CAAC,GAAG,CAAL,CAAb,EAAsB;AACpB;AACD;;AACD,kBAAII,CAAC,GAAGhB,CAAC,CAACY,CAAD,CAAT;AACAZ,cAAAA,CAAC,CAACY,CAAD,CAAD,GAAOZ,CAAC,CAACY,CAAC,GAAG,CAAL,CAAR;AACAZ,cAAAA,CAAC,CAACY,CAAC,GAAG,CAAL,CAAD,GAAWI,CAAX;;AACA,kBAAI5B,KAAK,IAAIwB,CAAC,GAAG/B,CAAC,GAAG,CAArB,EAAwB;AACtB,qBAAK,IAAI0B,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG1B,CAApB,EAAuB0B,CAAC,EAAxB,EAA4B;AAC1BS,kBAAAA,CAAC,GAAGb,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASK,CAAC,GAAG,CAAb,CAAJ;AACAT,kBAAAA,CAAC,CAACW,GAAF,CAAMP,CAAN,EAASK,CAAC,GAAG,CAAb,EAAgBT,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASK,CAAT,CAAhB;AACAT,kBAAAA,CAAC,CAACW,GAAF,CAAMP,CAAN,EAASK,CAAT,EAAYI,CAAZ;AACD;AACF;;AACD,kBAAI9B,KAAK,IAAI0B,CAAC,GAAGjC,CAAC,GAAG,CAArB,EAAwB;AACtB,qBAAK,IAAI4B,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG5B,CAApB,EAAuB4B,CAAC,EAAxB,EAA4B;AAC1BS,kBAAAA,CAAC,GAAGd,CAAC,CAACW,GAAF,CAAMN,CAAN,EAASK,CAAC,GAAG,CAAb,CAAJ;AACAV,kBAAAA,CAAC,CAACY,GAAF,CAAMP,CAAN,EAASK,CAAC,GAAG,CAAb,EAAgBV,CAAC,CAACW,GAAF,CAAMN,CAAN,EAASK,CAAT,CAAhB;AACAV,kBAAAA,CAAC,CAACY,GAAF,CAAMP,CAAN,EAASK,CAAT,EAAYI,CAAZ;AACD;AACF;;AACDJ,cAAAA,CAAC;AACF;;AACDO,YAAAA,IAAI,GAAG,CAAP;AACAF,YAAAA,CAAC;AACD;AACD;AACD;AAjJF;AAmJD;;AAED,QAAI5B,OAAJ,EAAa;AACX,UAAIsD,GAAG,GAAGxC,CAAV;AACAA,MAAAA,CAAC,GAAGD,CAAJ;AACAA,MAAAA,CAAC,GAAGyC,GAAJ;AACD;;AAED,SAAKhE,CAAL,GAASA,CAAT;AACA,SAAKE,CAAL,GAASA,CAAT;AACA,SAAKmB,CAAL,GAASA,CAAT;AACA,SAAKE,CAAL,GAASA,CAAT;AACA,SAAKC,CAAL,GAASA,CAAT;AACD;;AAEDyC,EAAAA,KAAK,CAACpE,KAAD,EAAQ;AACX,QAAIqE,CAAC,GAAGrE,KAAR;AACA,QAAI4B,CAAC,GAAG,KAAK0C,SAAb;AACA,QAAIC,KAAK,GAAG,KAAK/C,CAAL,CAAOgD,MAAnB;AACA,QAAIC,EAAE,GAAG9E,MAAM,CAAC+E,KAAP,CAAaH,KAAb,EAAoBA,KAApB,CAAT;;AAEA,SAAK,IAAIxC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGwC,KAApB,EAA2BxC,CAAC,EAA5B,EAAgC;AAC9B,UAAIV,IAAI,CAAC6B,GAAL,CAAS,KAAK1B,CAAL,CAAOO,CAAP,CAAT,KAAuBH,CAA3B,EAA8B;AAC5B6C,QAAAA,EAAE,CAACnC,GAAH,CAAOP,CAAP,EAAUA,CAAV,EAAa,CAAb;AACD,OAFD,MAEO;AACL0C,QAAAA,EAAE,CAACnC,GAAH,CAAOP,CAAP,EAAUA,CAAV,EAAa,IAAI,KAAKP,CAAL,CAAOO,CAAP,CAAjB;AACD;AACF;;AAED,QAAIL,CAAC,GAAG,KAAKA,CAAb;AACA,QAAIC,CAAC,GAAG,KAAKgD,oBAAb;AAEA,QAAIC,EAAE,GAAGjD,CAAC,CAACkD,IAAF,CAAOJ,EAAP,CAAT;AACA,QAAIK,KAAK,GAAGnD,CAAC,CAACvB,IAAd;AACA,QAAI2E,KAAK,GAAGrD,CAAC,CAACtB,IAAd;AACA,QAAI4E,GAAG,GAAGrF,MAAM,CAAC+E,KAAP,CAAaI,KAAb,EAAoBC,KAApB,CAAV;;AAEA,SAAK,IAAIhD,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG+C,KAApB,EAA2B/C,CAAC,EAA5B,EAAgC;AAC9B,WAAK,IAAIQ,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGwC,KAApB,EAA2BxC,CAAC,EAA5B,EAAgC;AAC9B,YAAI0C,GAAG,GAAG,CAAV;;AACA,aAAK,IAAI7C,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGmC,KAApB,EAA2BnC,CAAC,EAA5B,EAAgC;AAC9B6C,UAAAA,GAAG,IAAIL,EAAE,CAACvC,GAAH,CAAON,CAAP,EAAUK,CAAV,IAAeV,CAAC,CAACW,GAAF,CAAME,CAAN,EAASH,CAAT,CAAtB;AACD;;AACD4C,QAAAA,GAAG,CAAC1C,GAAJ,CAAQP,CAAR,EAAWQ,CAAX,EAAc0C,GAAd;AACD;AACF;;AAED,WAAOD,GAAG,CAACH,IAAJ,CAASR,CAAT,CAAP;AACD;;AAEDa,EAAAA,gBAAgB,CAAClF,KAAD,EAAQ;AACtB,WAAO,KAAKoE,KAAL,CAAWzE,MAAM,CAACwF,IAAP,CAAYnF,KAAZ,CAAX,CAAP;AACD;;AAEDoF,EAAAA,OAAO,GAAG;AACR,QAAIzD,CAAC,GAAG,KAAKA,CAAb;AACA,QAAIC,CAAC,GAAG,KAAK0C,SAAb;AACA,QAAIQ,KAAK,GAAGnD,CAAC,CAACvB,IAAd;AACA,QAAIiF,KAAK,GAAG1D,CAAC,CAACrB,OAAd;AACA,QAAIgF,CAAC,GAAG,IAAI3F,MAAJ,CAAWmF,KAAX,EAAkB,KAAKtD,CAAL,CAAOgD,MAAzB,CAAR;;AAEA,SAAK,IAAIzC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG+C,KAApB,EAA2B/C,CAAC,EAA5B,EAAgC;AAC9B,WAAK,IAAIQ,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG8C,KAApB,EAA2B9C,CAAC,EAA5B,EAAgC;AAC9B,YAAIlB,IAAI,CAAC6B,GAAL,CAAS,KAAK1B,CAAL,CAAOe,CAAP,CAAT,IAAsBX,CAA1B,EAA6B;AAC3B0D,UAAAA,CAAC,CAAChD,GAAF,CAAMP,CAAN,EAASQ,CAAT,EAAYZ,CAAC,CAACU,GAAF,CAAMN,CAAN,EAASQ,CAAT,IAAc,KAAKf,CAAL,CAAOe,CAAP,CAA1B;AACD;AACF;AACF;;AAED,QAAIb,CAAC,GAAG,KAAKA,CAAb;AAEA,QAAIqD,KAAK,GAAGrD,CAAC,CAACtB,IAAd;AACA,QAAImF,KAAK,GAAG7D,CAAC,CAACpB,OAAd;AACA,QAAI+D,CAAC,GAAG,IAAI1E,MAAJ,CAAWmF,KAAX,EAAkBC,KAAlB,CAAR;;AAEA,SAAK,IAAIhD,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG+C,KAApB,EAA2B/C,CAAC,EAA5B,EAAgC;AAC9B,WAAK,IAAIQ,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGwC,KAApB,EAA2BxC,CAAC,EAA5B,EAAgC;AAC9B,YAAI0C,GAAG,GAAG,CAAV;;AACA,aAAK,IAAI7C,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGmD,KAApB,EAA2BnD,CAAC,EAA5B,EAAgC;AAC9B6C,UAAAA,GAAG,IAAIK,CAAC,CAACjD,GAAF,CAAMN,CAAN,EAASK,CAAT,IAAcV,CAAC,CAACW,GAAF,CAAME,CAAN,EAASH,CAAT,CAArB;AACD;;AACDiC,QAAAA,CAAC,CAAC/B,GAAF,CAAMP,CAAN,EAASQ,CAAT,EAAY0C,GAAZ;AACD;AACF;;AAED,WAAOZ,CAAP;AACD;;AAED,MAAImB,SAAJ,GAAgB;AACd,WAAO,KAAKhE,CAAL,CAAO,CAAP,IAAY,KAAKA,CAAL,CAAOH,IAAI,CAACC,GAAL,CAAS,KAAKnB,CAAd,EAAiB,KAAKE,CAAtB,IAA2B,CAAlC,CAAnB;AACD;;AAED,MAAIoF,KAAJ,GAAY;AACV,WAAO,KAAKjE,CAAL,CAAO,CAAP,CAAP;AACD;;AAED,MAAIkE,IAAJ,GAAW;AACT,QAAIC,GAAG,GAAGtE,IAAI,CAACa,GAAL,CAAS,KAAK/B,CAAd,EAAiB,KAAKE,CAAtB,IAA2B,KAAKmB,CAAL,CAAO,CAAP,CAA3B,GAAuCqB,MAAM,CAACC,OAAxD;AACA,QAAI8C,CAAC,GAAG,CAAR;AACA,QAAIpE,CAAC,GAAG,KAAKA,CAAb;;AACA,SAAK,IAAIO,CAAC,GAAG,CAAR,EAAW8D,EAAE,GAAGrE,CAAC,CAACgD,MAAvB,EAA+BzC,CAAC,GAAG8D,EAAnC,EAAuC9D,CAAC,EAAxC,EAA4C;AAC1C,UAAIP,CAAC,CAACO,CAAD,CAAD,GAAO4D,GAAX,EAAgB;AACdC,QAAAA,CAAC;AACF;AACF;;AACD,WAAOA,CAAP;AACD;;AAED,MAAIE,QAAJ,GAAe;AACb,WAAOC,KAAK,CAACC,IAAN,CAAW,KAAKxE,CAAhB,CAAP;AACD;;AAED,MAAI8C,SAAJ,GAAgB;AACd,WAAQzB,MAAM,CAACC,OAAP,GAAiB,CAAlB,GAAuBzB,IAAI,CAACa,GAAL,CAAS,KAAK/B,CAAd,EAAiB,KAAKE,CAAtB,CAAvB,GAAkD,KAAKmB,CAAL,CAAO,CAAP,CAAzD;AACD;;AAED,MAAIyE,mBAAJ,GAA0B;AACxB,WAAO,KAAKvE,CAAZ;AACD;;AAED,MAAIiD,oBAAJ,GAA2B;AACzB,WAAO,KAAKhD,CAAZ;AACD;;AAED,MAAIuE,cAAJ,GAAqB;AACnB,WAAOvG,MAAM,CAACwF,IAAP,CAAY,KAAK3D,CAAjB,CAAP;AACD;;AApgB6C","sourcesContent":["import Matrix from '../matrix';\nimport WrapperMatrix2D from '../wrap/WrapperMatrix2D';\n\nimport { hypotenuse } from './util';\n\nexport default class SingularValueDecomposition {\n  constructor(value, options = {}) {\n    value = WrapperMatrix2D.checkMatrix(value);\n\n    let m = value.rows;\n    let n = value.columns;\n\n    const {\n      computeLeftSingularVectors = true,\n      computeRightSingularVectors = true,\n      autoTranspose = false,\n    } = options;\n\n    let wantu = Boolean(computeLeftSingularVectors);\n    let wantv = Boolean(computeRightSingularVectors);\n\n    let swapped = false;\n    let a;\n    if (m < n) {\n      if (!autoTranspose) {\n        a = value.clone();\n        // eslint-disable-next-line no-console\n        console.warn(\n          'Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose',\n        );\n      } else {\n        a = value.transpose();\n        m = a.rows;\n        n = a.columns;\n        swapped = true;\n        let aux = wantu;\n        wantu = wantv;\n        wantv = aux;\n      }\n    } else {\n      a = value.clone();\n    }\n\n    let nu = Math.min(m, n);\n    let ni = Math.min(m + 1, n);\n    let s = new Float64Array(ni);\n    let U = new Matrix(m, nu);\n    let V = new Matrix(n, n);\n\n    let e = new Float64Array(n);\n    let work = new Float64Array(m);\n\n    let si = new Float64Array(ni);\n    for (let i = 0; i < ni; i++) si[i] = i;\n\n    let nct = Math.min(m - 1, n);\n    let nrt = Math.max(0, Math.min(n - 2, m));\n    let mrc = Math.max(nct, nrt);\n\n    for (let k = 0; k < mrc; k++) {\n      if (k < nct) {\n        s[k] = 0;\n        for (let i = k; i < m; i++) {\n          s[k] = hypotenuse(s[k], a.get(i, k));\n        }\n        if (s[k] !== 0) {\n          if (a.get(k, k) < 0) {\n            s[k] = -s[k];\n          }\n          for (let i = k; i < m; i++) {\n            a.set(i, k, a.get(i, k) / s[k]);\n          }\n          a.set(k, k, a.get(k, k) + 1);\n        }\n        s[k] = -s[k];\n      }\n\n      for (let j = k + 1; j < n; j++) {\n        if (k < nct && s[k] !== 0) {\n          let t = 0;\n          for (let i = k; i < m; i++) {\n            t += a.get(i, k) * a.get(i, j);\n          }\n          t = -t / a.get(k, k);\n          for (let i = k; i < m; i++) {\n            a.set(i, j, a.get(i, j) + t * a.get(i, k));\n          }\n        }\n        e[j] = a.get(k, j);\n      }\n\n      if (wantu && k < nct) {\n        for (let i = k; i < m; i++) {\n          U.set(i, k, a.get(i, k));\n        }\n      }\n\n      if (k < nrt) {\n        e[k] = 0;\n        for (let i = k + 1; i < n; i++) {\n          e[k] = hypotenuse(e[k], e[i]);\n        }\n        if (e[k] !== 0) {\n          if (e[k + 1] < 0) {\n            e[k] = 0 - e[k];\n          }\n          for (let i = k + 1; i < n; i++) {\n            e[i] /= e[k];\n          }\n          e[k + 1] += 1;\n        }\n        e[k] = -e[k];\n        if (k + 1 < m && e[k] !== 0) {\n          for (let i = k + 1; i < m; i++) {\n            work[i] = 0;\n          }\n          for (let i = k + 1; i < m; i++) {\n            for (let j = k + 1; j < n; j++) {\n              work[i] += e[j] * a.get(i, j);\n            }\n          }\n          for (let j = k + 1; j < n; j++) {\n            let t = -e[j] / e[k + 1];\n            for (let i = k + 1; i < m; i++) {\n              a.set(i, j, a.get(i, j) + t * work[i]);\n            }\n          }\n        }\n        if (wantv) {\n          for (let i = k + 1; i < n; i++) {\n            V.set(i, k, e[i]);\n          }\n        }\n      }\n    }\n\n    let p = Math.min(n, m + 1);\n    if (nct < n) {\n      s[nct] = a.get(nct, nct);\n    }\n    if (m < p) {\n      s[p - 1] = 0;\n    }\n    if (nrt + 1 < p) {\n      e[nrt] = a.get(nrt, p - 1);\n    }\n    e[p - 1] = 0;\n\n    if (wantu) {\n      for (let j = nct; j < nu; j++) {\n        for (let i = 0; i < m; i++) {\n          U.set(i, j, 0);\n        }\n        U.set(j, j, 1);\n      }\n      for (let k = nct - 1; k >= 0; k--) {\n        if (s[k] !== 0) {\n          for (let j = k + 1; j < nu; j++) {\n            let t = 0;\n            for (let i = k; i < m; i++) {\n              t += U.get(i, k) * U.get(i, j);\n            }\n            t = -t / U.get(k, k);\n            for (let i = k; i < m; i++) {\n              U.set(i, j, U.get(i, j) + t * U.get(i, k));\n            }\n          }\n          for (let i = k; i < m; i++) {\n            U.set(i, k, -U.get(i, k));\n          }\n          U.set(k, k, 1 + U.get(k, k));\n          for (let i = 0; i < k - 1; i++) {\n            U.set(i, k, 0);\n          }\n        } else {\n          for (let i = 0; i < m; i++) {\n            U.set(i, k, 0);\n          }\n          U.set(k, k, 1);\n        }\n      }\n    }\n\n    if (wantv) {\n      for (let k = n - 1; k >= 0; k--) {\n        if (k < nrt && e[k] !== 0) {\n          for (let j = k + 1; j < n; j++) {\n            let t = 0;\n            for (let i = k + 1; i < n; i++) {\n              t += V.get(i, k) * V.get(i, j);\n            }\n            t = -t / V.get(k + 1, k);\n            for (let i = k + 1; i < n; i++) {\n              V.set(i, j, V.get(i, j) + t * V.get(i, k));\n            }\n          }\n        }\n        for (let i = 0; i < n; i++) {\n          V.set(i, k, 0);\n        }\n        V.set(k, k, 1);\n      }\n    }\n\n    let pp = p - 1;\n    let iter = 0;\n    let eps = Number.EPSILON;\n    while (p > 0) {\n      let k, kase;\n      for (k = p - 2; k >= -1; k--) {\n        if (k === -1) {\n          break;\n        }\n        const alpha =\n          Number.MIN_VALUE + eps * Math.abs(s[k] + Math.abs(s[k + 1]));\n        if (Math.abs(e[k]) <= alpha || Number.isNaN(e[k])) {\n          e[k] = 0;\n          break;\n        }\n      }\n      if (k === p - 2) {\n        kase = 4;\n      } else {\n        let ks;\n        for (ks = p - 1; ks >= k; ks--) {\n          if (ks === k) {\n            break;\n          }\n          let t =\n            (ks !== p ? Math.abs(e[ks]) : 0) +\n            (ks !== k + 1 ? Math.abs(e[ks - 1]) : 0);\n          if (Math.abs(s[ks]) <= eps * t) {\n            s[ks] = 0;\n            break;\n          }\n        }\n        if (ks === k) {\n          kase = 3;\n        } else if (ks === p - 1) {\n          kase = 1;\n        } else {\n          kase = 2;\n          k = ks;\n        }\n      }\n\n      k++;\n\n      switch (kase) {\n        case 1: {\n          let f = e[p - 2];\n          e[p - 2] = 0;\n          for (let j = p - 2; j >= k; j--) {\n            let t = hypotenuse(s[j], f);\n            let cs = s[j] / t;\n            let sn = f / t;\n            s[j] = t;\n            if (j !== k) {\n              f = -sn * e[j - 1];\n              e[j - 1] = cs * e[j - 1];\n            }\n            if (wantv) {\n              for (let i = 0; i < n; i++) {\n                t = cs * V.get(i, j) + sn * V.get(i, p - 1);\n                V.set(i, p - 1, -sn * V.get(i, j) + cs * V.get(i, p - 1));\n                V.set(i, j, t);\n              }\n            }\n          }\n          break;\n        }\n        case 2: {\n          let f = e[k - 1];\n          e[k - 1] = 0;\n          for (let j = k; j < p; j++) {\n            let t = hypotenuse(s[j], f);\n            let cs = s[j] / t;\n            let sn = f / t;\n            s[j] = t;\n            f = -sn * e[j];\n            e[j] = cs * e[j];\n            if (wantu) {\n              for (let i = 0; i < m; i++) {\n                t = cs * U.get(i, j) + sn * U.get(i, k - 1);\n                U.set(i, k - 1, -sn * U.get(i, j) + cs * U.get(i, k - 1));\n                U.set(i, j, t);\n              }\n            }\n          }\n          break;\n        }\n        case 3: {\n          const scale = Math.max(\n            Math.abs(s[p - 1]),\n            Math.abs(s[p - 2]),\n            Math.abs(e[p - 2]),\n            Math.abs(s[k]),\n            Math.abs(e[k]),\n          );\n          const sp = s[p - 1] / scale;\n          const spm1 = s[p - 2] / scale;\n          const epm1 = e[p - 2] / scale;\n          const sk = s[k] / scale;\n          const ek = e[k] / scale;\n          const b = ((spm1 + sp) * (spm1 - sp) + epm1 * epm1) / 2;\n          const c = sp * epm1 * (sp * epm1);\n          let shift = 0;\n          if (b !== 0 || c !== 0) {\n            if (b < 0) {\n              shift = 0 - Math.sqrt(b * b + c);\n            } else {\n              shift = Math.sqrt(b * b + c);\n            }\n            shift = c / (b + shift);\n          }\n          let f = (sk + sp) * (sk - sp) + shift;\n          let g = sk * ek;\n          for (let j = k; j < p - 1; j++) {\n            let t = hypotenuse(f, g);\n            if (t === 0) t = Number.MIN_VALUE;\n            let cs = f / t;\n            let sn = g / t;\n            if (j !== k) {\n              e[j - 1] = t;\n            }\n            f = cs * s[j] + sn * e[j];\n            e[j] = cs * e[j] - sn * s[j];\n            g = sn * s[j + 1];\n            s[j + 1] = cs * s[j + 1];\n            if (wantv) {\n              for (let i = 0; i < n; i++) {\n                t = cs * V.get(i, j) + sn * V.get(i, j + 1);\n                V.set(i, j + 1, -sn * V.get(i, j) + cs * V.get(i, j + 1));\n                V.set(i, j, t);\n              }\n            }\n            t = hypotenuse(f, g);\n            if (t === 0) t = Number.MIN_VALUE;\n            cs = f / t;\n            sn = g / t;\n            s[j] = t;\n            f = cs * e[j] + sn * s[j + 1];\n            s[j + 1] = -sn * e[j] + cs * s[j + 1];\n            g = sn * e[j + 1];\n            e[j + 1] = cs * e[j + 1];\n            if (wantu && j < m - 1) {\n              for (let i = 0; i < m; i++) {\n                t = cs * U.get(i, j) + sn * U.get(i, j + 1);\n                U.set(i, j + 1, -sn * U.get(i, j) + cs * U.get(i, j + 1));\n                U.set(i, j, t);\n              }\n            }\n          }\n          e[p - 2] = f;\n          iter = iter + 1;\n          break;\n        }\n        case 4: {\n          if (s[k] <= 0) {\n            s[k] = s[k] < 0 ? -s[k] : 0;\n            if (wantv) {\n              for (let i = 0; i <= pp; i++) {\n                V.set(i, k, -V.get(i, k));\n              }\n            }\n          }\n          while (k < pp) {\n            if (s[k] >= s[k + 1]) {\n              break;\n            }\n            let t = s[k];\n            s[k] = s[k + 1];\n            s[k + 1] = t;\n            if (wantv && k < n - 1) {\n              for (let i = 0; i < n; i++) {\n                t = V.get(i, k + 1);\n                V.set(i, k + 1, V.get(i, k));\n                V.set(i, k, t);\n              }\n            }\n            if (wantu && k < m - 1) {\n              for (let i = 0; i < m; i++) {\n                t = U.get(i, k + 1);\n                U.set(i, k + 1, U.get(i, k));\n                U.set(i, k, t);\n              }\n            }\n            k++;\n          }\n          iter = 0;\n          p--;\n          break;\n        }\n        // no default\n      }\n    }\n\n    if (swapped) {\n      let tmp = V;\n      V = U;\n      U = tmp;\n    }\n\n    this.m = m;\n    this.n = n;\n    this.s = s;\n    this.U = U;\n    this.V = V;\n  }\n\n  solve(value) {\n    let Y = value;\n    let e = this.threshold;\n    let scols = this.s.length;\n    let Ls = Matrix.zeros(scols, scols);\n\n    for (let i = 0; i < scols; i++) {\n      if (Math.abs(this.s[i]) <= e) {\n        Ls.set(i, i, 0);\n      } else {\n        Ls.set(i, i, 1 / this.s[i]);\n      }\n    }\n\n    let U = this.U;\n    let V = this.rightSingularVectors;\n\n    let VL = V.mmul(Ls);\n    let vrows = V.rows;\n    let urows = U.rows;\n    let VLU = Matrix.zeros(vrows, urows);\n\n    for (let i = 0; i < vrows; i++) {\n      for (let j = 0; j < urows; j++) {\n        let sum = 0;\n        for (let k = 0; k < scols; k++) {\n          sum += VL.get(i, k) * U.get(j, k);\n        }\n        VLU.set(i, j, sum);\n      }\n    }\n\n    return VLU.mmul(Y);\n  }\n\n  solveForDiagonal(value) {\n    return this.solve(Matrix.diag(value));\n  }\n\n  inverse() {\n    let V = this.V;\n    let e = this.threshold;\n    let vrows = V.rows;\n    let vcols = V.columns;\n    let X = new Matrix(vrows, this.s.length);\n\n    for (let i = 0; i < vrows; i++) {\n      for (let j = 0; j < vcols; j++) {\n        if (Math.abs(this.s[j]) > e) {\n          X.set(i, j, V.get(i, j) / this.s[j]);\n        }\n      }\n    }\n\n    let U = this.U;\n\n    let urows = U.rows;\n    let ucols = U.columns;\n    let Y = new Matrix(vrows, urows);\n\n    for (let i = 0; i < vrows; i++) {\n      for (let j = 0; j < urows; j++) {\n        let sum = 0;\n        for (let k = 0; k < ucols; k++) {\n          sum += X.get(i, k) * U.get(j, k);\n        }\n        Y.set(i, j, sum);\n      }\n    }\n\n    return Y;\n  }\n\n  get condition() {\n    return this.s[0] / this.s[Math.min(this.m, this.n) - 1];\n  }\n\n  get norm2() {\n    return this.s[0];\n  }\n\n  get rank() {\n    let tol = Math.max(this.m, this.n) * this.s[0] * Number.EPSILON;\n    let r = 0;\n    let s = this.s;\n    for (let i = 0, ii = s.length; i < ii; i++) {\n      if (s[i] > tol) {\n        r++;\n      }\n    }\n    return r;\n  }\n\n  get diagonal() {\n    return Array.from(this.s);\n  }\n\n  get threshold() {\n    return (Number.EPSILON / 2) * Math.max(this.m, this.n) * this.s[0];\n  }\n\n  get leftSingularVectors() {\n    return this.U;\n  }\n\n  get rightSingularVectors() {\n    return this.V;\n  }\n\n  get diagonalMatrix() {\n    return Matrix.diag(this.s);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}