import { __assign } from "tslib";
import { map } from '@antv/util';
import { flow, findGeometry } from '../../../utils';
import { getTooltipMapping } from '../../../utils/tooltip';
import { geometry as baseGeometry } from '../../../adaptor/geometries/base';
import { FUNNEL_CONVERSATION, FUNNEL_PERCENT } from '../constant';
import { geometryLabel, conversionTagComponent } from './common';
/**
 * 处理字段数据
 * @param params
 */
function field(params) {
    var chart = params.chart, options = params.options;
    var _a = options.data, data = _a === void 0 ? [] : _a, yField = options.yField;
    var formatData = [];
    // format 数据
    if (data[0][yField]) {
        formatData = map(data, function (row, index) {
            if (row[yField] !== undefined) {
                row[FUNNEL_PERCENT] = row[yField] / data[0][yField];
                row[FUNNEL_CONVERSATION] = index === 0 ? 1 : row[yField] / data[index - 1][yField];
            }
            return row;
        });
    }
    // 绘制漏斗图
    chart.data(formatData);
    return params;
}
/**
 * geometry处理
 * @param params
 */
function geometry(params) {
    var chart = params.chart, options = params.options;
    var xField = options.xField, yField = options.yField, color = options.color, tooltip = options.tooltip;
    var _a = getTooltipMapping(tooltip, [xField, yField, FUNNEL_PERCENT, FUNNEL_CONVERSATION]), fields = _a.fields, formatter = _a.formatter;
    baseGeometry({
        chart: chart,
        options: {
            type: 'interval',
            xField: xField,
            yField: yField,
            colorField: xField,
            tooltipFields: fields,
            mapping: {
                shape: 'funnel',
                tooltip: formatter,
                color: color,
            },
        },
    });
    var geo = findGeometry(params.chart, 'interval');
    geo.adjust('symmetric');
    return params;
}
/**
 * 转置处理
 * @param params
 */
function transpose(params) {
    var chart = params.chart, options = params.options;
    var isTransposed = options.isTransposed;
    chart.coordinate({
        type: 'rect',
        actions: !isTransposed ? [['transpose'], ['scale', 1, -1]] : [],
    });
    return params;
}
/**
 * label 处理
 * @param params
 */
function label(params) {
    geometryLabel(findGeometry(params.chart, 'interval'))(params);
    return params;
}
/**
 * 转化率组件
 * @param params
 */
function conversionTag(params) {
    var options = params.options;
    var yField = options.yField;
    var getLineCoordinate = function (datum, datumIndex, data, initLineOption) {
        var percent = 1 - (1 - datum[FUNNEL_PERCENT]) / 2;
        return __assign(__assign({}, initLineOption), { start: [datumIndex - 0.5, data[0][yField] * percent], end: [datumIndex - 0.5, data[0][yField] * (percent + 0.05)] });
    };
    conversionTagComponent(getLineCoordinate)(params);
    return params;
}
/**
 * 基础漏斗
 * @param chart
 * @param options
 */
export function basicFunnel(params) {
    return flow(field, geometry, transpose, conversionTag, label)(params);
}
//# sourceMappingURL=basic.js.map